#delimit;
set more off;
set matsize 800;
set mem 3000m;
cap log close;
log using data_construction, replace;

*First, generate the instrument;

do usa_00074;
keep if gq==1|gq==2;
drop if year==1900|year==1940;
gen yob=year-age;
replace yrimmig=1000+yrimmig if yrimmig~=0;
replace yrimmig=. if yrimmig==0;
gen immig=(bpld>=15000 & bpld<90000);
drop if immig==1 & yrimmig==.;
drop if immig==1 & yrimmig<yob;
gen ageimmig=yrimmig-yob;

*Generates 3 immigrant categories: young, baby and old;

gen young_imm=ageimmig>=10 & ageimmig<=25 & immig==1;
replace young_imm=ageimmig>=8 & ageimmig<=23 & immig==1 if sex==2;
gen baby_imm=ageimmig<10 & immig==1;
replace baby_imm=ageimmig<8 & immig==1 if sex==2;
gen old_imm=ageimmig>30 & immig==1;
replace old_imm=ageimmig>28 & immig==1 if sex==2;

*Generates natives and second generations;

gen secondgen=((mbpld>=15000 & mbpld<90000) | (fbpld>=15000 & fbpld<90000))& bpld<15000;
gen native=bpld<15000 & mbpld<15000 & fbpld<15000;
drop if native==0 & secondgen==0 & immig==0;

*Generate ethnicities which are later on grouped into ethnic group according to Table C1;
gen ethnic=0 if native==1|secondgen==1;
replace ethnic=1 if bpld>=60000 & bpld<=60099;
replace ethnic=2 if bpld>=16000 & bpld<=16060;
replace ethnic=3 if bpld>=70000 & bpld<=70010;
replace ethnic=4 if bpld>=45000 & bpld<=45080;
replace ethnic=5 if bpld==42000;
replace ethnic=6 if (bpld>=45200 & bpld<=45212);
replace ethnic=7 if bpld>=15000 & bpld<=15070;
replace ethnic=8 if bpld>=15080 & bpld<=15083;
replace ethnic=8 if ethnic==7 & mtongue==11;
replace ethnic=9 if bpld>=21000 & bpld<=21090;
replace ethnic=10 if bpld>=50000 & bpld<=50040;
replace ethnic=11 if bpld==41900 | bpld==42200 | bpld==42400 | bpld==43000 | bpld==43100 | bpld==43200| bpld==43500 | bpld==43700 | bpld==44000|bpld==45100| (bpld>=45700 & bpld<=45900)|bpld==41900|bpld==42900|bpld==44000|bpld==49900;
replace ethnic=12 if bpld==25000;
replace ethnic=13 if bpld==40000|bpld==40200;
replace ethnic=14 if (bpld>=41000 & bpld<=41020) | bpld==41300;
replace ethnic=15 if bpld==40100;
replace ethnic=16 if bpld==42100;
replace ethnic=17 if (bpld>=45300 & bpld<=45362) | (bpld>42100 & bpld<=42112);
replace ethnic=18 if bpld>=43300 & bpld<=43330;
replace ethnic=19 if bpld==45400;
replace ethnic=20 if bpld>=52100 & bpld<=52150;
replace ethnic=21 if bpld>=41400 & bpld<=41410;
replace ethnic=22 if bpld==43400;
replace ethnic=23 if bpld==50100;
replace ethnic=24 if bpld==42300;
replace ethnic=25 if bpld==20000;
replace ethnic=26 if bpld==42500;
replace ethnic=27 if bpld==40400;
replace ethnic=28 if (bpld>=50200 & bpld<=52000) | (bpld>=52200 & bpld<=54000) | (bpld<=54300 & bpld>=59900);
replace ethnic=30 if bpld>=71000 & bpld<=71050;
replace ethnic=31 if bpld>=45500 & bpld<=45530;
replace ethnic=32 if bpld>=43600 & bpld<=43640;
replace ethnic=33 if bpld>=45600 & bpld<=45610;
replace ethnic=34 if bpld>=46000 & bpld<=46590;
replace ethnic=35 if bpld==41100;
replace ethnic=36 if bpld>=30000 & bpld<=30091;
replace ethnic=37 if bpld==43800;
replace ethnic=38 if bpld==40500;
replace ethnic=39 if bpld==42600;
replace ethnic=40 if (bpld>=53400 & bpld<=53440) | bpld==54100 | (bpld>=54200 & bpld<=54220);
replace ethnic=41 if bpld==41200;
replace ethnic=42 if bpld>=26000 & bpld<=26095;
replace ethnic=29 if bpld>=15000 & bpld<90000 & ethnic==.;

gen momethnic=0 if mbpld<15000;
replace momethnic=1 if mbpld>=60000 & mbpld<=60099;
replace momethnic=2 if mbpld>=16000 & mbpld<=16060;
replace momethnic=3 if mbpld>=70000 & mbpld<=70010;
replace momethnic=4 if mbpld>=45000 & mbpld<=45080;
replace momethnic=5 if mbpld==42000;
replace momethnic=6 if (mbpld>=45200 & mbpld<=45212);
replace momethnic=7 if mbpld>=15000 & mbpld<=15070;
replace momethnic=8 if mbpld>=15080 & mbpld<=15083;
replace momethnic=8 if momethnic==7 & mmtongue==11;
replace momethnic=9 if mbpld>=21000 & mbpld<=21090;
replace momethnic=10 if mbpld>=50000 & mbpld<=50040;
replace momethnic=11 if mbpld==41900 | mbpld==42200 | mbpld==42400 | mbpld==43000 | mbpld==43100 | mbpld==43200| mbpld==43500 | mbpld==43700 | mbpld==44000 | mbpld==45100|(mbpld>=45700 & mbpld<=45900)|mbpld==41900|mbpld==42900|mbpld==44000|mbpld==49900;
replace momethnic=12 if mbpld==25000;
replace momethnic=13 if mbpld==40000|mbpld==40200;
replace momethnic=14 if (mbpld>=41000 & mbpld<=41020) | mbpld==41300;
replace momethnic=15 if mbpld==40100;
replace momethnic=16 if mbpld==42100;
replace momethnic=17 if (mbpld>=45300 & mbpld<=45362) |(mbpld>42100 & mbpld<=42112);
replace momethnic=18 if mbpld>=43300 & mbpld<=43330;
replace momethnic=19 if mbpld==45400;
replace momethnic=20 if mbpld>=52100 & mbpld<=52150;
replace momethnic=21 if mbpld>=41400 & mbpld<=41410;
replace momethnic=22 if mbpld==43400;
replace momethnic=23 if mbpld==50100;
replace momethnic=24 if mbpld==42300;
replace momethnic=25 if mbpld==20000;
replace momethnic=26 if mbpld==42500;
replace momethnic=27 if mbpld==40400;
replace momethnic=28 if (mbpld>=50200 & mbpld<=52000) | (mbpld>=52200 & mbpld<=54000) | (mbpld<=54300 & mbpld>=59900);
replace momethnic=30 if mbpld>=71000 & mbpld<=71050;
replace momethnic=31 if mbpld>=45500 & mbpld<=45530;
replace momethnic=32 if mbpld>=43600 & mbpld<=43640;
replace momethnic=33 if mbpld>=45600 & mbpld<=45610;
replace momethnic=34 if mbpld>=46000 & mbpld<=46590;
replace momethnic=35 if mbpld==41100;
replace momethnic=36 if mbpld>=30000 & mbpld<=30091;
replace momethnic=37 if mbpld==43800;
replace momethnic=38 if mbpld==40500;
replace momethnic=39 if mbpld==42600;
replace momethnic=40 if (mbpld>=53400 & mbpld<=53440) | mbpld==54100 | (mbpld>=54200 & mbpld<=54220);
replace momethnic=41 if mbpld==41200;
replace momethnic=42 if mbpld>=26000 & mbpld<=26095;
replace momethnic=29 if mbpld>=15000 & mbpld<90000 & momethnic==.;

gen dadethnic=0 if fbpld<15000;
replace dadethnic=1 if fbpld>=60000 & fbpld<=60099;
replace dadethnic=2 if fbpld>=16000 & fbpld<=16060;
replace dadethnic=3 if fbpld>=70000 & fbpld<=70010;
replace dadethnic=4 if fbpld>=45000 & fbpld<=45080;
replace dadethnic=5 if fbpld==42000;
replace dadethnic=6 if (fbpld>=45200 & fbpld<=45212);
replace dadethnic=7 if fbpld>=15000 & fbpld<=15070;
replace dadethnic=8 if fbpld>=15080 & fbpld<=15083;
replace dadethnic=8 if dadethnic==7 & fmtongue==11;
replace dadethnic=9 if fbpld>=21000 & fbpld<=21090;
replace dadethnic=10 if fbpld>=50000 & fbpld<=50040;
replace dadethnic=11 if fbpld==41900 | fbpld==42200 | fbpld==42400 | fbpld==43000 | fbpld==43100 | fbpld==43200| fbpld==43500 | fbpld==43700 | fbpld==44000|fbpld==45100|(fbpld>=45700 & fbpld<=45900)|fbpld==41900|fbpld==42900|fbpld==44000|fbpld==49900;
replace dadethnic=12 if fbpld==25000;
replace dadethnic=13 if fbpld==40000|fbpld==40200;
replace dadethnic=14 if (fbpld>=41000 & fbpld<=41020) | fbpld==41300;
replace dadethnic=15 if fbpld==40100;
replace dadethnic=16 if fbpld==42100;
replace dadethnic=17 if (fbpld>=45300 & fbpld<=45362) | (fbpld>42100 & fbpld<=42112);
replace dadethnic=18 if fbpld>=43300 & fbpld<=43330;
replace dadethnic=19 if fbpld==45400;
replace dadethnic=20 if fbpld>=52100 & fbpld<=52150;
replace dadethnic=21 if fbpld>=41400 & fbpld<=41410;
replace dadethnic=22 if fbpld==43400;
replace dadethnic=23 if fbpld==50100;
replace dadethnic=24 if fbpld==42300;
replace dadethnic=25 if fbpld==20000;
replace dadethnic=26 if fbpld==42500;
replace dadethnic=27 if fbpld==40400;
replace dadethnic=28 if (fbpld>=50200 & fbpld<=52000) | (fbpld>=52200 & fbpld<=54000) | (fbpld<=54300 & fbpld>=59900);
replace dadethnic=30 if fbpld>=71000 & fbpld<=71050;
replace dadethnic=31 if fbpld>=45500 & fbpld<=45530;
replace dadethnic=32 if fbpld>=43600 & fbpld<=43640;
replace dadethnic=33 if fbpld>=45600 & fbpld<=45610;
replace dadethnic=34 if fbpld>=46000 & fbpld<=46590;
replace dadethnic=35 if fbpld==41100;
replace dadethnic=36 if fbpld>=30000 & fbpld<=30091;
replace dadethnic=37 if fbpld==43800;
replace dadethnic=38 if fbpld==40500;
replace dadethnic=39 if fbpld==42600;
replace dadethnic=40 if (fbpld>=53400 & fbpld<=53440) | fbpld==54100 | (fbpld>=54200 & fbpld<=54220);
replace dadethnic=41 if fbpld==41200;
replace dadethnic=42 if fbpld>=26000 & fbpld<=26095;
replace dadethnic=29 if fbpld>=15000 & fbpld<90000 & dadethnic==.;


*For second generation, use the ethnicity of the father if foreign-born and then of the mother if the father is native born;
replace ethnic=dadethnic if ethnic==.|ethnic==0;
replace ethnic=momethnic if ethnic==.|ethnic==0;
drop if ethnic==.;

*Group immigrants into cohorts of immigration (or births for individuals who immigrated as children);
gen period_imm=5*(floor(yrimmig/5));
replace period_imm=5*(floor(yob/5))+15 if young_imm==0&old_imm==0;
keep if period_imm>=1900 & period_imm<=1925;

gen female=sex==2;
gen male=sex==1;
gen female_young=female*young_imm;
gen male_young=male*young_imm;
gen female_baby=female*baby_imm;
gen male_baby=male*baby_imm;
gen female_old=female*old_imm;
gen male_old=male*old_imm;
gen male_sec=male*secondgen;
gen female_sec=female*secondgen;


*Avoid double counting by restricting the flow/stock variables to be measured only once;
foreach x of varlist young_imm baby_imm old_imm secondgen native{;
replace `x'=. if year==1910 & (period_imm<1900 | period_imm>=1910);
replace `x'=. if year==1920 & (period_imm<1910 | period_imm>=1920);
replace `x'=. if year==1930 & (period_imm<1920 | period_imm>=1930);
};

*Drop observations for which the period of immigration was coded properly;
foreach x of varlist male female female_young male_young female_baby male_baby female_old male_old male_sec female_sec{;
replace `x'=. if year==1910 & period_imm>=1910;
replace `x'=. if year==1920 & period_imm>=1920;
replace `x'=. if year==1930 & period_imm>=1930;
};

save by_state, replace;


*Use national stocks and state-specific shares to construct the instruments;
drop if immig==0;

collapse (sum)young_imm (sum)baby_imm (sum)old_imm (sum)female* (sum)male* , by(period_imm ethnic), [aw=perwt];
drop if ethnic==0;
fillin ethnic period_imm;
tab _fillin;
foreach x of varlist young_imm-male_old{;
replace `x'=0 if _fillin==1;
};
drop _fillin;
sort ethnic;
merge ethnic using immigration_shares_census2;
tab _merge;
drop _merge;

replace oklahoma=oklahoma+indianterritory if indianterritory~=.;
replace oklahoma=indianterritory if oklahoma==.;
drop indianterritory;
foreach i of varlist alabama-wyoming{;
gen per_`i'=`i'/total;
gen pred_young`i'=per_`i'*young_imm;
gen pred_baby`i'=per_`i'*baby_imm;
gen pred_old`i'=per_`i'*old_imm;
gen pred_male_young`i'=per_`i'*male_young;
gen pred_female_young`i'=per_`i'*female_young;
gen pred_male_baby`i'=per_`i'*male_baby;
gen pred_female_baby`i'=per_`i'*female_baby;
gen pred_male_old`i'=per_`i'*male_old;
gen pred_female_old`i'=per_`i'*female_old;
rename `i' weight`i';
drop per_`i';
};

drop female* male*;

reshape long weight pred_young pred_baby pred_old pred_male_young pred_male_baby pred_male_old pred_female_young pred_female_baby pred_female_old, i(ethnic period_imm) j(state_name) string;
gen state=mod(_n,51);
replace state=51 if state==0;

*Join observations by ethnic groups (called ethnic_small);

gen ethnic_small=1 if ethnic==3|ethnic==7|ethnic==14|ethnic==35|ethnic==41|ethnic==21;
replace ethnic_small=2 if ethnic==5|ethnic==8|ethnic==16;
replace ethnic_small=3 if ethnic==22|ethnic==32|ethnic==37;
replace ethnic_small=4 if ethnic==9|ethnic==12|ethnic==36|ethnic==42|ethnic==25;
replace ethnic_small=5 if ethnic==13|ethnic==15|ethnic==27|ethnic==38;
replace ethnic_small=6 if ethnic==4|ethnic==17|ethnic==39|ethnic==24|ethnic==26;
replace ethnic_small=7 if ethnic==31|ethnic==33|ethnic==34;
replace ethnic_small=8 if ethnic==19|ethnic==6|ethnic==18|ethnic==11;
replace ethnic_small=9 if ethnic==10|ethnic==20|ethnic==23|ethnic==28|ethnic==40|ethnic==1|ethnic==2|ethnic==29|ethnic==30;

collapse (sum)pred_*, by(ethnic_small period_imm state);

rename pred_young pred_imm;

*Make adjustments for empty cells;
gen pred_sexratio_imm=(pred_male_young/pred_female_young);
replace pred_sexratio_imm=1.5*(pred_male_young) if pred_female_young==0;
replace pred_sexratio_imm=1 if pred_female_young==0 & pred_male_young==0;
sort ethnic_small period_imm state;
save instrument, replace;


*Generate the endogenous variable;

use by_state;
gen state=statefip;
replace state=floor(bpld/100) if bpld<15000;
replace state=state-1 if state>=4;
replace state=state-1 if state>=7;
replace state=state-1 if state>=13;
replace state=state-1 if state>=41;
replace state=state-1 if state>=49;
drop if state>51;

gen lit_imm_female=lit==4 if lit~=0 & lit~=. & sex==2 & young_imm==1;
gen lit_imm_male=lit==4 if lit~=0 & lit~=. & sex==1 & young_imm==1;

gen ethnic_small=1 if ethnic==3|ethnic==7|ethnic==14|ethnic==35|ethnic==41|ethnic==21;
replace ethnic_small=2 if ethnic==5|ethnic==8|ethnic==16;
replace ethnic_small=3 if ethnic==22|ethnic==32|ethnic==37;
replace ethnic_small=4 if ethnic==9|ethnic==12|ethnic==36|ethnic==42|ethnic==25;
replace ethnic_small=5 if ethnic==13|ethnic==15|ethnic==27|ethnic==38;
replace ethnic_small=6 if ethnic==4|ethnic==17|ethnic==39|ethnic==24|ethnic==26;
replace ethnic_small=7 if ethnic==31|ethnic==33|ethnic==34;
replace ethnic_small=8 if ethnic==19|ethnic==6|ethnic==18|ethnic==11;
replace ethnic_small=9 if ethnic==10|ethnic==20|ethnic==23|ethnic==28|ethnic==40|ethnic==1|ethnic==2|ethnic==29|ethnic==30;

gen malenat=male*native;
gen femalenat=female*native;

bysort state period_imm: egen male_nat=total(malenat);
bysort state period_imm: egen female_nat=total(femalenat);

drop malenat femalenat;
drop if ethnic==0;

rename female_young female_imm;
rename male_young male_imm;

drop ethnic;

collapse (sum)secondgen (sum)young_imm (sum)baby_imm (sum)old_imm (sum)female_baby (sum)male_baby (sum)female_old (sum)male_old (sum)female_imm (sum)male_imm (sum)female_sec (sum)male_sec (sum)lit_imm_female (sum) lit_imm_male (mean)male_nat (mean)female_nat, by(period_imm ethnic_small state), [aw=perwt];

fillin period_imm state ethnic_small;
foreach x of varlist young_imm-female_nat{;
replace `x'=0 if _fillin==1;
};
drop _fillin;

sort ethnic_small period_imm state;
merge ethnic_small period_imm state using instrument;
tab _merge;
drop _merge;


gen sec=secondgen+baby_imm+young_imm;
gen male_tot=male_sec+male_imm+male_baby;
gen female_tot=female_sec+female_imm+female_baby;

gen per_lit_imm_young_female=lit_imm_female/female_imm;
replace per_lit_imm_young_female=0 if female_imm==0;
gen per_lit_imm_young_male=lit_imm_male/male_imm;
replace per_lit_imm_young_male=0 if male_imm==0;

gen sexratio_tot=male_tot/female_tot;
gen sexratio_imm_young=male_imm/female_imm;
gen sexratio_nat=male_nat/female_nat;
gen sexratio_old=male_old/female_old;
gen sexratio_baby=male_baby/female_baby;

*Make adjustments for empty cells;
replace sexratio_tot=1.5*(male_tot) if female_tot==0;
replace sexratio_tot=1 if male_tot==0 & female_tot==0;
replace sexratio_imm_young=1.5*(male_imm) if female_imm==0;
replace sexratio_imm_young=1 if male_imm==0 & female_imm==0;
replace sexratio_nat=1.5*(male_nat) if female_nat==0;
replace sexratio_nat=1 if male_nat==0 & female_nat==0;
replace sexratio_old=1.5*(male_old) if female_old==0;
replace sexratio_old=1 if male_old==0 & female_old==0;
replace sexratio_baby=1.5*(male_baby) if female_baby==0;
replace sexratio_baby=1 if male_baby==0 & female_baby==0;

rename sec stock_sec_young;
replace stock_sec_young=0 if stock_sec_young==.;
rename young_imm stock_imm_young;
replace stock_imm_young=0 if stock_imm_young==.;
rename old_imm stock_imm_old;
replace stock_imm_old=0 if stock_imm_old==.;
rename baby_imm stock_imm_baby;
replace stock_imm_baby=0 if stock_imm_baby==.;

gen pred_total=pred_imm+pred_baby+stock_sec_young;

gen pred_sexratio_total=(pred_male_young+pred_male_baby+male_sec)/(pred_female_baby+pred_female_young+female_sec);
replace pred_sexratio_total=1.5*(pred_male_young+pred_male_baby+male_sec) if pred_female_young+female_sec+pred_female_baby==0;
replace pred_sexratio_total=1 if pred_total==0;
gen pred_sexratio_old=pred_male_old/pred_female_old;
replace pred_sexratio_old=1.5*(pred_male_old) if pred_female_old==0;
replace pred_sexratio_old=1 if pred_male_old==0 & pred_female_old==0;

gen stock_all=stock_sec_young+stock_imm_old;

replace stock_imm_young=stock_imm_young/1000;
replace stock_sec_young=stock_sec_young/1000;
replace stock_imm_old=stock_imm_old/1000;

replace pred_total=pred_total/1000;
replace pred_imm=pred_imm/1000;
replace pred_old=pred_old/1000;

keep pred_old male_imm female_imm  male_tot female_tot sexratio_* stock_* pred_total pred_imm pred_sexratio_* ethnic_small state period_imm;

sort ethnic_small period_imm state;
save instrument, replace;

*Now constructing the outcomes file:

*First building the outcomes for females and merging spousal attributes;
do jeanne_lafortune_utoronto_ca_070;
keep if sex==1;
foreach var in age race higrade lit agemarr marrno empstat labforce wkswork2 hrswork2 bpl mbpl fbpl mtongue edscor50 statefip{;
rename `var' `var'_male;
};
keep *_male year datanum serial pernum sploc;
sort year datanum serial pernum;
save outcomes_females, replace;

do jeanne_lafortune_utoronto_ca_070;
keep if sex==2;
rename pernum pernum_female;
rename sploc pernum;
sort year datanum serial pernum;
merge year datanum serial pernum using outcomes_females;
tab _merge;
drop if _merge==2;
drop _merge;
gen yob=year-age;
save outcomes_females, replace;

*Build ethnic characteristics using older cohort;

keep if yob<1885 & yob>=1865;

gen ethnic=0 if bpld<15000;
replace ethnic=1 if bpld>=60000 & bpld<=60099;
replace ethnic=2 if bpld>=16000 & bpld<=16060;
replace ethnic=3 if bpld>=70000 & bpld<=70010;
replace ethnic=4 if bpld>=45000 & bpld<=45080;
replace ethnic=5 if bpld==42000;
replace ethnic=6 if (bpld>=45200 & bpld<=45212);
replace ethnic=7 if bpld>=15000 & bpld<=15070;
replace ethnic=8 if bpld>=15080 & bpld<=15083;
replace ethnic=8 if ethnic==7 & mtongue==11;
replace ethnic=9 if bpld>=21000 & bpld<=21090;
replace ethnic=10 if bpld>=50000 & bpld<=50040;
replace ethnic=11 if bpld==41900 | bpld==42200 | bpld==42400 | bpld==43000 | bpld==43100 | bpld==43200| bpld==43500 | bpld==43700 | bpld==44000|bpld==45100| (bpld>=45700 & bpld<=45900)|bpld==41900|bpld==42900|bpld==44000|bpld==49900;
replace ethnic=12 if bpld==25000;
replace ethnic=13 if bpld==40000|bpld==40200;
replace ethnic=14 if (bpld>=41000 & bpld<=41020) | bpld==41300;
replace ethnic=15 if bpld==40100;
replace ethnic=16 if bpld==42100;
replace ethnic=17 if (bpld>=45300 & bpld<=45362) | (bpld>42100 & bpld<=42112);
replace ethnic=18 if bpld>=43300 & bpld<=43330;
replace ethnic=19 if bpld==45400;
replace ethnic=20 if bpld>=52100 & bpld<=52150;
replace ethnic=21 if bpld>=41400 & bpld<=41410;
replace ethnic=22 if bpld==43400;
replace ethnic=23 if bpld==50100;
replace ethnic=24 if bpld==42300;
replace ethnic=25 if bpld==20000;
replace ethnic=26 if bpld==42500;
replace ethnic=27 if bpld==40400;
replace ethnic=28 if (bpld>=50200 & bpld<=52000) | (bpld>=52200 & bpld<=54000) | (bpld<=54300 & bpld>=59900);
replace ethnic=30 if bpld>=71000 & bpld<=71050;
replace ethnic=31 if bpld>=45500 & bpld<=45530;
replace ethnic=32 if bpld>=43600 & bpld<=43640;
replace ethnic=33 if bpld>=45600 & bpld<=45610;
replace ethnic=34 if bpld>=46000 & bpld<=46590;
replace ethnic=35 if bpld==41100;
replace ethnic=36 if bpld>=30000 & bpld<=30091;
replace ethnic=37 if bpld==43800;
replace ethnic=38 if bpld==40500;
replace ethnic=39 if bpld==42600;
replace ethnic=40 if (bpld>=53400 & bpld<=53440) | bpld==54100 | (bpld>=54200 & bpld<=54220);
replace ethnic=41 if bpld==41200;
replace ethnic=42 if bpld>=26000 & bpld<=26095;
replace ethnic=29 if bpld>=15000 & bpld<90000 & ethnic==.;

gen momethnic=0 if mbpld<15000;
replace momethnic=1 if mbpld>=60000 & mbpld<=60099;
replace momethnic=2 if mbpld>=16000 & mbpld<=16060;
replace momethnic=3 if mbpld>=70000 & mbpld<=70010;
replace momethnic=4 if mbpld>=45000 & mbpld<=45080;
replace momethnic=5 if mbpld==42000;
replace momethnic=6 if (mbpld>=45200 & mbpld<=45212);
replace momethnic=7 if mbpld>=15000 & mbpld<=15070;
replace momethnic=8 if mbpld>=15080 & mbpld<=15083;
replace momethnic=8 if momethnic==7 & mtongue==11;
replace momethnic=9 if mbpld>=21000 & mbpld<=21090;
replace momethnic=10 if mbpld>=50000 & mbpld<=50040;
replace momethnic=11 if mbpld==41900 | mbpld==42200 | mbpld==42400 | mbpld==43000 | mbpld==43100 | mbpld==43200| mbpld==43500 | mbpld==43700 | mbpld==44000 | mbpld==45100|(mbpld>=45700 & mbpld<=45900)|mbpld==41900|mbpld==42900|mbpld==44000|mbpld==49900;
replace momethnic=12 if mbpld==25000;
replace momethnic=13 if mbpld==40000|mbpld==40200;
replace momethnic=14 if (mbpld>=41000 & mbpld<=41020) | mbpld==41300;
replace momethnic=15 if mbpld==40100;
replace momethnic=16 if mbpld==42100;
replace momethnic=17 if (mbpld>=45300 & mbpld<=45362) |(mbpld>42100 & mbpld<=42112);
replace momethnic=18 if mbpld>=43300 & mbpld<=43330;
replace momethnic=19 if mbpld==45400;
replace momethnic=20 if mbpld>=52100 & mbpld<=52150;
replace momethnic=21 if mbpld>=41400 & mbpld<=41410;
replace momethnic=22 if mbpld==43400;
replace momethnic=23 if mbpld==50100;
replace momethnic=24 if mbpld==42300;
replace momethnic=25 if mbpld==20000;
replace momethnic=26 if mbpld==42500;
replace momethnic=27 if mbpld==40400;
replace momethnic=28 if (mbpld>=50200 & mbpld<=52000) | (mbpld>=52200 & mbpld<=54000) | (mbpld<=54300 & mbpld>=59900);
replace momethnic=30 if mbpld>=71000 & mbpld<=71050;
replace momethnic=31 if mbpld>=45500 & mbpld<=45530;
replace momethnic=32 if mbpld>=43600 & mbpld<=43640;
replace momethnic=33 if mbpld>=45600 & mbpld<=45610;
replace momethnic=34 if mbpld>=46000 & mbpld<=46590;
replace momethnic=35 if mbpld==41100;
replace momethnic=36 if mbpld>=30000 & mbpld<=30091;
replace momethnic=37 if mbpld==43800;
replace momethnic=38 if mbpld==40500;
replace momethnic=39 if mbpld==42600;
replace momethnic=40 if (mbpld>=53400 & mbpld<=53440) | mbpld==54100 | (mbpld>=54200 & mbpld<=54220);
replace momethnic=41 if mbpld==41200;
replace momethnic=42 if mbpld>=26000 & mbpld<=26095;
replace momethnic=29 if mbpld>=15000 & mbpld<90000 & momethnic==.;

gen dadethnic=0 if fbpld<15000;
replace dadethnic=1 if fbpld>=60000 & fbpld<=60099;
replace dadethnic=2 if fbpld>=16000 & fbpld<=16060;
replace dadethnic=3 if fbpld>=70000 & fbpld<=70010;
replace dadethnic=4 if fbpld>=45000 & fbpld<=45080;
replace dadethnic=5 if fbpld==42000;
replace dadethnic=6 if (fbpld>=45200 & fbpld<=45212);
replace dadethnic=7 if fbpld>=15000 & fbpld<=15070;
replace dadethnic=8 if fbpld>=15080 & fbpld<=15083;
replace dadethnic=8 if dadethnic==7 & mtongue==11;
replace dadethnic=9 if fbpld>=21000 & fbpld<=21090;
replace dadethnic=10 if fbpld>=50000 & fbpld<=50040;
replace dadethnic=11 if fbpld==41900 | fbpld==42200 | fbpld==42400 | fbpld==43000 | fbpld==43100 | fbpld==43200| fbpld==43500 | fbpld==43700 | fbpld==44000|fbpld==45100|(fbpld>=45700 & fbpld<=45900)|fbpld==41900|fbpld==42900|fbpld==44000|fbpld==49900;
replace dadethnic=12 if fbpld==25000;
replace dadethnic=13 if fbpld==40000|fbpld==40200;
replace dadethnic=14 if (fbpld>=41000 & fbpld<=41020) | fbpld==41300;
replace dadethnic=15 if fbpld==40100;
replace dadethnic=16 if fbpld==42100;
replace dadethnic=17 if (fbpld>=45300 & fbpld<=45362) | (fbpld>42100 & fbpld<=42112);
replace dadethnic=18 if fbpld>=43300 & fbpld<=43330;
replace dadethnic=19 if fbpld==45400;
replace dadethnic=20 if fbpld>=52100 & fbpld<=52150;
replace dadethnic=21 if fbpld>=41400 & fbpld<=41410;
replace dadethnic=22 if fbpld==43400;
replace dadethnic=23 if fbpld==50100;
replace dadethnic=24 if fbpld==42300;
replace dadethnic=25 if fbpld==20000;
replace dadethnic=26 if fbpld==42500;
replace dadethnic=27 if fbpld==40400;
replace dadethnic=28 if (fbpld>=50200 & fbpld<=52000) | (fbpld>=52200 & fbpld<=54000) | (fbpld<=54300 & fbpld>=59900);
replace dadethnic=30 if fbpld>=71000 & fbpld<=71050;
replace dadethnic=31 if fbpld>=45500 & fbpld<=45530;
replace dadethnic=32 if fbpld>=43600 & fbpld<=43640;
replace dadethnic=33 if fbpld>=45600 & fbpld<=45610;
replace dadethnic=34 if fbpld>=46000 & fbpld<=46590;
replace dadethnic=35 if fbpld==41100;
replace dadethnic=36 if fbpld>=30000 & fbpld<=30091;
replace dadethnic=37 if fbpld==43800;
replace dadethnic=38 if fbpld==40500;
replace dadethnic=39 if fbpld==42600;
replace dadethnic=40 if (fbpld>=53400 & fbpld<=53440) | fbpld==54100 | (fbpld>=54200 & fbpld<=54220);
replace dadethnic=41 if fbpld==41200;
replace dadethnic=42 if fbpld>=26000 & fbpld<=26095;
replace dadethnic=29 if fbpld>=15000 & fbpld<90000 & dadethnic==.;

replace ethnic=dadethnic if ethnic==.|ethnic==0;
replace ethnic=momethnic if ethnic==.|ethnic==0;

gen ethnic_small=1 if ethnic==3|ethnic==7|ethnic==14|ethnic==35|ethnic==41|ethnic==21;
replace ethnic_small=2 if ethnic==5|ethnic==8|ethnic==16;
replace ethnic_small=3 if ethnic==22|ethnic==32|ethnic==37;
replace ethnic_small=4 if ethnic==9|ethnic==12|ethnic==36|ethnic==42|ethnic==25;
replace ethnic_small=5 if ethnic==13|ethnic==15|ethnic==27|ethnic==38;
replace ethnic_small=6 if ethnic==4|ethnic==17|ethnic==39|ethnic==24|ethnic==26;
replace ethnic_small=7 if ethnic==31|ethnic==33|ethnic==34;
replace ethnic_small=8 if ethnic==19|ethnic==6|ethnic==18|ethnic==11;
replace ethnic_small=9 if ethnic==10|ethnic==20|ethnic==23|ethnic==28|ethnic==40|ethnic==1|ethnic==2|ethnic==29|ethnic==30;
replace ethnic_small=0 if ethnic==0;

gen ethnic_male=0 if bpl_male<15000;
replace ethnic_male=1 if bpl_male>=60000 & bpl_male<=60099;
replace ethnic_male=2 if bpl_male>=16000 & bpl_male<=16060;
replace ethnic_male=3 if bpl_male>=70000 & bpl_male<=70010;
replace ethnic_male=4 if bpl_male>=45000 & bpl_male<=45080;
replace ethnic_male=5 if bpl_male==42000;
replace ethnic_male=6 if (bpl_male>=45200 & bpl_male<=45212);
replace ethnic_male=7 if bpl_male>=15000 & bpl_male<=15070;
replace ethnic_male=8 if bpl_male>=15080 & bpl_male<=15083;
replace ethnic_male=8 if ethnic_male==7 & mtongue_male==11;
replace ethnic_male=9 if bpl_male>=21000 & bpl_male<=21090;
replace ethnic_male=10 if bpl_male>=50000 & bpl_male<=50040;
replace ethnic_male=11 if bpl_male==41900 | bpl_male==42200 | bpl_male==42400 | bpl_male==43000 | bpl_male==43100 | bpl_male==43200| bpl_male==43500 | bpl_male==43700 | bpl_male==44000|bpl_male==45100| (bpl_male>=45700 & bpl_male<=45900)|bpl_male==41900|bpl_male==42900|bpl_male==44000|bpl_male==49900;
replace ethnic_male=12 if bpl_male==25000;
replace ethnic_male=13 if bpl_male==40000|bpl_male==40200;
replace ethnic_male=14 if (bpl_male>=41000 & bpl_male<=41020) | bpl_male==41300;
replace ethnic_male=15 if bpl_male==40100;
replace ethnic_male=16 if bpl_male==42100;
replace ethnic_male=17 if (bpl_male>=45300 & bpl_male<=45362) | (bpl_male>42100 & bpl_male<=42112);
replace ethnic_male=18 if bpl_male>=43300 & bpl_male<=43330;
replace ethnic_male=19 if bpl_male==45400;
replace ethnic_male=20 if bpl_male>=52100 & bpl_male<=52150;
replace ethnic_male=21 if bpl_male>=41400 & bpl_male<=41410;
replace ethnic_male=22 if bpl_male==43400;
replace ethnic_male=23 if bpl_male==50100;
replace ethnic_male=24 if bpl_male==42300;
replace ethnic_male=25 if bpl_male==20000;
replace ethnic_male=26 if bpl_male==42500;
replace ethnic_male=27 if bpl_male==40400;
replace ethnic_male=28 if (bpl_male>=50200 & bpl_male<=52000) | (bpl_male>=52200 & bpl_male<=54000) | (bpl_male<=54300 & bpl_male>=59900);
replace ethnic_male=30 if bpl_male>=71000 & bpl_male<=71050;
replace ethnic_male=31 if bpl_male>=45500 & bpl_male<=45530;
replace ethnic_male=32 if bpl_male>=43600 & bpl_male<=43640;
replace ethnic_male=33 if bpl_male>=45600 & bpl_male<=45610;
replace ethnic_male=34 if bpl_male>=46000 & bpl_male<=46590;
replace ethnic_male=35 if bpl_male==41100;
replace ethnic_male=36 if bpl_male>=30000 & bpl_male<=30091;
replace ethnic_male=37 if bpl_male==43800;
replace ethnic_male=38 if bpl_male==40500;
replace ethnic_male=39 if bpl_male==42600;
replace ethnic_male=40 if (bpl_male>=53400 & bpl_male<=53440) | bpl_male==54100 | (bpl_male>=54200 & bpl_male<=54220);
replace ethnic_male=41 if bpl_male==41200;
replace ethnic_male=42 if bpl_male>=26000 & bpl_male<=26095;
replace ethnic_male=29 if bpl_male>=15000 & bpl_male<90000 & ethnic_male==.;

gen momethnic_male=0 if mbpl_male<15000;
replace momethnic_male=1 if mbpl_male>=60000 & mbpl_male<=60099;
replace momethnic_male=2 if mbpl_male>=16000 & mbpl_male<=16060;
replace momethnic_male=3 if mbpl_male>=70000 & mbpl_male<=70010;
replace momethnic_male=4 if mbpl_male>=45000 & mbpl_male<=45080;
replace momethnic_male=5 if mbpl_male==42000;
replace momethnic_male=6 if (mbpl_male>=45200 & mbpl_male<=45212);
replace momethnic_male=7 if mbpl_male>=15000 & mbpl_male<=15070;
replace momethnic_male=8 if mbpl_male>=15080 & mbpl_male<=15083;
replace momethnic_male=8 if momethnic_male==7 & mtongue_male==11;
replace momethnic_male=9 if mbpl_male>=21000 & mbpl_male<=21090;
replace momethnic_male=10 if mbpl_male>=50000 & mbpl_male<=50040;
replace momethnic_male=11 if mbpl_male==41900 | mbpl_male==42200 | mbpl_male==42400 | mbpl_male==43000 | mbpl_male==43100 | mbpl_male==43200| mbpl_male==43500 | mbpl_male==43700 | mbpl_male==44000 | mbpl_male==45100|(mbpl_male>=45700 & mbpl_male<=45900)|mbpl_male==41900|mbpl_male==42900|mbpl_male==44000|mbpl_male==49900;
replace momethnic_male=12 if mbpl_male==25000;
replace momethnic_male=13 if mbpl_male==40000|mbpl_male==40200;
replace momethnic_male=14 if (mbpl_male>=41000 & mbpl_male<=41020) | mbpl_male==41300;
replace momethnic_male=15 if mbpl_male==40100;
replace momethnic_male=16 if mbpl_male==42100;
replace momethnic_male=17 if (mbpl_male>=45300 & mbpl_male<=45362) |(mbpl_male>42100 & mbpl_male<=42112);
replace momethnic_male=18 if mbpl_male>=43300 & mbpl_male<=43330;
replace momethnic_male=19 if mbpl_male==45400;
replace momethnic_male=20 if mbpl_male>=52100 & mbpl_male<=52150;
replace momethnic_male=21 if mbpl_male>=41400 & mbpl_male<=41410;
replace momethnic_male=22 if mbpl_male==43400;
replace momethnic_male=23 if mbpl_male==50100;
replace momethnic_male=24 if mbpl_male==42300;
replace momethnic_male=25 if mbpl_male==20000;
replace momethnic_male=26 if mbpl_male==42500;
replace momethnic_male=27 if mbpl_male==40400;
replace momethnic_male=28 if (mbpl_male>=50200 & mbpl_male<=52000) | (mbpl_male>=52200 & mbpl_male<=54000) | (mbpl_male<=54300 & mbpl_male>=59900);
replace momethnic_male=30 if mbpl_male>=71000 & mbpl_male<=71050;
replace momethnic_male=31 if mbpl_male>=45500 & mbpl_male<=45530;
replace momethnic_male=32 if mbpl_male>=43600 & mbpl_male<=43640;
replace momethnic_male=33 if mbpl_male>=45600 & mbpl_male<=45610;
replace momethnic_male=34 if mbpl_male>=46000 & mbpl_male<=46590;
replace momethnic_male=35 if mbpl_male==41100;
replace momethnic_male=36 if mbpl_male>=30000 & mbpl_male<=30091;
replace momethnic_male=37 if mbpl_male==43800;
replace momethnic_male=38 if mbpl_male==40500;
replace momethnic_male=39 if mbpl_male==42600;
replace momethnic_male=40 if (mbpl_male>=53400 & mbpl_male<=53440) | mbpl_male==54100 | (mbpl_male>=54200 & mbpl_male<=54220);
replace momethnic_male=41 if mbpl_male==41200;
replace momethnic_male=42 if mbpl_male>=26000 & mbpl_male<=26095;
replace momethnic_male=29 if mbpl_male>=15000 & mbpl_male<90000 & momethnic_male==.;

gen dadethnic_male=0 if fbpl_male<15000;
replace dadethnic_male=1 if fbpl_male>=60000 & fbpl_male<=60099;
replace dadethnic_male=2 if fbpl_male>=16000 & fbpl_male<=16060;
replace dadethnic_male=3 if fbpl_male>=70000 & fbpl_male<=70010;
replace dadethnic_male=4 if fbpl_male>=45000 & fbpl_male<=45080;
replace dadethnic_male=5 if fbpl_male==42000;
replace dadethnic_male=6 if (fbpl_male>=45200 & fbpl_male<=45212);
replace dadethnic_male=7 if fbpl_male>=15000 & fbpl_male<=15070;
replace dadethnic_male=8 if fbpl_male>=15080 & fbpl_male<=15083;
replace dadethnic_male=8 if dadethnic_male==7 & mtongue_male==11;
replace dadethnic_male=9 if fbpl_male>=21000 & fbpl_male<=21090;
replace dadethnic_male=10 if fbpl_male>=50000 & fbpl_male<=50040;
replace dadethnic_male=11 if fbpl_male==41900 | fbpl_male==42200 | fbpl_male==42400 | fbpl_male==43000 | fbpl_male==43100 | fbpl_male==43200| fbpl_male==43500 | fbpl_male==43700 | fbpl_male==44000|fbpl_male==45100|(fbpl_male>=45700 & fbpl_male<=45900)|fbpl_male==41900|fbpl_male==42900|fbpl_male==44000|fbpl_male==49900;
replace dadethnic_male=12 if fbpl_male==25000;
replace dadethnic_male=13 if fbpl_male==40000|fbpl_male==40200;
replace dadethnic_male=14 if (fbpl_male>=41000 & fbpl_male<=41020) | fbpl_male==41300;
replace dadethnic_male=15 if fbpl_male==40100;
replace dadethnic_male=16 if fbpl_male==42100;
replace dadethnic_male=17 if (fbpl_male>=45300 & fbpl_male<=45362) | (fbpl_male>42100 & fbpl_male<=42112);
replace dadethnic_male=18 if fbpl_male>=43300 & fbpl_male<=43330;
replace dadethnic_male=19 if fbpl_male==45400;
replace dadethnic_male=20 if fbpl_male>=52100 & fbpl_male<=52150;
replace dadethnic_male=21 if fbpl_male>=41400 & fbpl_male<=41410;
replace dadethnic_male=22 if fbpl_male==43400;
replace dadethnic_male=23 if fbpl_male==50100;
replace dadethnic_male=24 if fbpl_male==42300;
replace dadethnic_male=25 if fbpl_male==20000;
replace dadethnic_male=26 if fbpl_male==42500;
replace dadethnic_male=27 if fbpl_male==40400;
replace dadethnic_male=28 if (fbpl_male>=50200 & fbpl_male<=52000) | (fbpl_male>=52200 & fbpl_male<=54000) | (fbpl_male<=54300 & fbpl_male>=59900);
replace dadethnic_male=30 if fbpl_male>=71000 & fbpl_male<=71050;
replace dadethnic_male=31 if fbpl_male>=45500 & fbpl_male<=45530;
replace dadethnic_male=32 if fbpl_male>=43600 & fbpl_male<=43640;
replace dadethnic_male=33 if fbpl_male>=45600 & fbpl_male<=45610;
replace dadethnic_male=34 if fbpl_male>=46000 & fbpl_male<=46590;
replace dadethnic_male=35 if fbpl_male==41100;
replace dadethnic_male=36 if fbpl_male>=30000 & fbpl_male<=30091;
replace dadethnic_male=37 if fbpl_male==43800;
replace dadethnic_male=38 if fbpl_male==40500;
replace dadethnic_male=39 if fbpl_male==42600;
replace dadethnic_male=40 if (fbpl_male>=53400 & fbpl_male<=53440) | fbpl_male==54100 | (fbpl_male>=54200 & fbpl_male<=54220);
replace dadethnic_male=41 if fbpl_male==41200;
replace dadethnic_male=42 if fbpl_male>=26000 & fbpl_male<=26095;
replace dadethnic_male=29 if fbpl_male>=15000 & fbpl_male<90000 & dadethnic_male==.;

replace ethnic_male=dadethnic_male if ethnic_male==.|ethnic_male==0;
replace ethnic_male=momethnic_male if ethnic_male==.|ethnic_male==0;

gen ethnic_small_male=1 if ethnic_male==3|ethnic_male==7|ethnic_male==14|ethnic_male==35|ethnic_male==41|ethnic_male==21;
replace ethnic_small_male=2 if ethnic_male==5|ethnic_male==8|ethnic_male==16;
replace ethnic_small_male=3 if ethnic_male==22|ethnic_male==32|ethnic_male==37;
replace ethnic_small_male=4 if ethnic_male==9|ethnic_male==12|ethnic_male==36|ethnic_male==42|ethnic_male==25;
replace ethnic_small_male=5 if ethnic_male==13|ethnic_male==15|ethnic_male==27|ethnic_male==38;
replace ethnic_small_male=6 if ethnic_male==4|ethnic_male==17|ethnic_male==39|ethnic_male==24|ethnic_male==26;
replace ethnic_small_male=7 if ethnic_male==31|ethnic_male==33|ethnic_male==34;
replace ethnic_small_male=8 if ethnic_male==19|ethnic_male==6|ethnic_male==18|ethnic_male==11;
replace ethnic_small_male=9 if ethnic_male==10|ethnic_male==20|ethnic_male==23|ethnic_male==28|ethnic_male==40|ethnic_male==1|ethnic_male==2|ethnic_male==29|ethnic_male==30;
replace ethnic_small_male=0 if ethnic_male==0;

gen immig_male=bpl_male>=15000 if bpl_male<=90000 & bpl_male~=0 & bpld<15000;
gen sameethnic=ethnic_small==ethnic_small_male if ethnic_small_male~=. & bpld<15000;
gen immig_same_male=immig_male*sameethnic;
gen otherethnic=(ethnic_small~=ethnic_small_male & ethnic_small_male~=0) if ethnic_male~=.& bpld<15000;
gen native=ethnic_male==0 if ethnic_male~=. & bpld<15000;
gen educ_immig_female=higrade if bpld>=15000 & bpld<90000;
gen samecountry=ethnic==ethnic_male if ethnic_male~=. & bpld<15000;

gen stock_female=1;
gen married_female=ethnic_male~=.& bpld<15000;
gen divorced_female=marst==4;
gen evermarried_female=1-(marst==6);

collapse (sum)divorced_female (sum)evermarried_female (sum)stock_female (sum)married_female (mean)educ_immig_female (mean)samecountry (mean)sameethnic (mean)immig_male (mean)immig_same_male (mean)otherethnic (mean)native (mean)higrade, by(ethnic_small ethnic);
rename samecountry samecountry_male;
rename sameethnic sameethnic_male;
rename otherethnic otherethnic_male;
rename native native_male;
rename higrade higrade_female;
gen divorce_rate_female=divorced_female/evermarried_female;
drop divorced_female evermarried_female;
drop if ethnic==.;
sort ethnic;
save characteristics_ethnic, replace;

*Now building the data for males, merging it with their spouses;

do jeanne_lafortune_utoronto_ca_070;
keep if sex==2;
foreach var in age race higrade lit agemarr marrno empstat labforce wkswork2 hrswork2 bpl mbpl fbpl mtongue edscor50 statefip{;
rename `var' `var'_female;
};
keep *_female year datanum serial pernum sploc;
sort year datanum serial pernum;
save outcomes_males, replace;

do jeanne_lafortune_utoronto_ca_070;
keep if sex==1;
rename pernum pernum_female;
rename sploc pernum;
sort year datanum serial pernum;
merge year datanum serial pernum using outcomes_males;
tab _merge;
drop if _merge==2;
drop _merge;
gen yob=year-age;
save outcomes_males, replace;

*Building ethnic characteristics using an older cohort;

keep if yob<1885 & yob>=1865;

gen ethnic=0 if bpld<15000;
replace ethnic=1 if bpld>=60000 & bpld<=60099;
replace ethnic=2 if bpld>=16000 & bpld<=16060;
replace ethnic=3 if bpld>=70000 & bpld<=70010;
replace ethnic=4 if bpld>=45000 & bpld<=45080;
replace ethnic=5 if bpld==42000;
replace ethnic=6 if (bpld>=45200 & bpld<=45212);
replace ethnic=7 if bpld>=15000 & bpld<=15070;
replace ethnic=8 if bpld>=15080 & bpld<=15083;
replace ethnic=8 if ethnic==7 & mtongue==11;
replace ethnic=9 if bpld>=21000 & bpld<=21090;
replace ethnic=10 if bpld>=50000 & bpld<=50040;
replace ethnic=11 if bpld==41900 | bpld==42200 | bpld==42400 | bpld==43000 | bpld==43100 | bpld==43200| bpld==43500 | bpld==43700 | bpld==44000|bpld==45100| (bpld>=45700 & bpld<=45900)|bpld==41900|bpld==42900|bpld==44000|bpld==49900;
replace ethnic=12 if bpld==25000;
replace ethnic=13 if bpld==40000|bpld==40200;
replace ethnic=14 if (bpld>=41000 & bpld<=41020) | bpld==41300;
replace ethnic=15 if bpld==40100;
replace ethnic=16 if bpld==42100;
replace ethnic=17 if (bpld>=45300 & bpld<=45362) | (bpld>42100 & bpld<=42112);
replace ethnic=18 if bpld>=43300 & bpld<=43330;
replace ethnic=19 if bpld==45400;
replace ethnic=20 if bpld>=52100 & bpld<=52150;
replace ethnic=21 if bpld>=41400 & bpld<=41410;
replace ethnic=22 if bpld==43400;
replace ethnic=23 if bpld==50100;
replace ethnic=24 if bpld==42300;
replace ethnic=25 if bpld==20000;
replace ethnic=26 if bpld==42500;
replace ethnic=27 if bpld==40400;
replace ethnic=28 if (bpld>=50200 & bpld<=52000) | (bpld>=52200 & bpld<=54000) | (bpld<=54300 & bpld>=59900);
replace ethnic=30 if bpld>=71000 & bpld<=71050;
replace ethnic=31 if bpld>=45500 & bpld<=45530;
replace ethnic=32 if bpld>=43600 & bpld<=43640;
replace ethnic=33 if bpld>=45600 & bpld<=45610;
replace ethnic=34 if bpld>=46000 & bpld<=46590;
replace ethnic=35 if bpld==41100;
replace ethnic=36 if bpld>=30000 & bpld<=30091;
replace ethnic=37 if bpld==43800;
replace ethnic=38 if bpld==40500;
replace ethnic=39 if bpld==42600;
replace ethnic=40 if (bpld>=53400 & bpld<=53440) | bpld==54100 | (bpld>=54200 & bpld<=54220);
replace ethnic=41 if bpld==41200;
replace ethnic=42 if bpld>=26000 & bpld<=26095;
replace ethnic=29 if bpld>=15000 & bpld<90000 & ethnic==.;

gen momethnic=0 if mbpld<15000;
replace momethnic=1 if mbpld>=60000 & mbpld<=60099;
replace momethnic=2 if mbpld>=16000 & mbpld<=16060;
replace momethnic=3 if mbpld>=70000 & mbpld<=70010;
replace momethnic=4 if mbpld>=45000 & mbpld<=45080;
replace momethnic=5 if mbpld==42000;
replace momethnic=6 if (mbpld>=45200 & mbpld<=45212);
replace momethnic=7 if mbpld>=15000 & mbpld<=15070;
replace momethnic=8 if mbpld>=15080 & mbpld<=15083;
replace momethnic=8 if momethnic==7 & mtongue==11;
replace momethnic=9 if mbpld>=21000 & mbpld<=21090;
replace momethnic=10 if mbpld>=50000 & mbpld<=50040;
replace momethnic=11 if mbpld==41900 | mbpld==42200 | mbpld==42400 | mbpld==43000 | mbpld==43100 | mbpld==43200| mbpld==43500 | mbpld==43700 | mbpld==44000 | mbpld==45100|(mbpld>=45700 & mbpld<=45900)|mbpld==41900|mbpld==42900|mbpld==44000|mbpld==49900;
replace momethnic=12 if mbpld==25000;
replace momethnic=13 if mbpld==40000|mbpld==40200;
replace momethnic=14 if (mbpld>=41000 & mbpld<=41020) | mbpld==41300;
replace momethnic=15 if mbpld==40100;
replace momethnic=16 if mbpld==42100;
replace momethnic=17 if (mbpld>=45300 & mbpld<=45362) |(mbpld>42100 & mbpld<=42112);
replace momethnic=18 if mbpld>=43300 & mbpld<=43330;
replace momethnic=19 if mbpld==45400;
replace momethnic=20 if mbpld>=52100 & mbpld<=52150;
replace momethnic=21 if mbpld>=41400 & mbpld<=41410;
replace momethnic=22 if mbpld==43400;
replace momethnic=23 if mbpld==50100;
replace momethnic=24 if mbpld==42300;
replace momethnic=25 if mbpld==20000;
replace momethnic=26 if mbpld==42500;
replace momethnic=27 if mbpld==40400;
replace momethnic=28 if (mbpld>=50200 & mbpld<=52000) | (mbpld>=52200 & mbpld<=54000) | (mbpld<=54300 & mbpld>=59900);
replace momethnic=30 if mbpld>=71000 & mbpld<=71050;
replace momethnic=31 if mbpld>=45500 & mbpld<=45530;
replace momethnic=32 if mbpld>=43600 & mbpld<=43640;
replace momethnic=33 if mbpld>=45600 & mbpld<=45610;
replace momethnic=34 if mbpld>=46000 & mbpld<=46590;
replace momethnic=35 if mbpld==41100;
replace momethnic=36 if mbpld>=30000 & mbpld<=30091;
replace momethnic=37 if mbpld==43800;
replace momethnic=38 if mbpld==40500;
replace momethnic=39 if mbpld==42600;
replace momethnic=40 if (mbpld>=53400 & mbpld<=53440) | mbpld==54100 | (mbpld>=54200 & mbpld<=54220);
replace momethnic=41 if mbpld==41200;
replace momethnic=42 if mbpld>=26000 & mbpld<=26095;
replace momethnic=29 if mbpld>=15000 & mbpld<90000 & momethnic==.;

gen dadethnic=0 if fbpld<15000;
replace dadethnic=1 if fbpld>=60000 & fbpld<=60099;
replace dadethnic=2 if fbpld>=16000 & fbpld<=16060;
replace dadethnic=3 if fbpld>=70000 & fbpld<=70010;
replace dadethnic=4 if fbpld>=45000 & fbpld<=45080;
replace dadethnic=5 if fbpld==42000;
replace dadethnic=6 if (fbpld>=45200 & fbpld<=45212);
replace dadethnic=7 if fbpld>=15000 & fbpld<=15070;
replace dadethnic=8 if fbpld>=15080 & fbpld<=15083;
replace dadethnic=8 if dadethnic==7 & mtongue==11;
replace dadethnic=9 if fbpld>=21000 & fbpld<=21090;
replace dadethnic=10 if fbpld>=50000 & fbpld<=50040;
replace dadethnic=11 if fbpld==41900 | fbpld==42200 | fbpld==42400 | fbpld==43000 | fbpld==43100 | fbpld==43200| fbpld==43500 | fbpld==43700 | fbpld==44000|fbpld==45100|(fbpld>=45700 & fbpld<=45900)|fbpld==41900|fbpld==42900|fbpld==44000|fbpld==49900;
replace dadethnic=12 if fbpld==25000;
replace dadethnic=13 if fbpld==40000|fbpld==40200;
replace dadethnic=14 if (fbpld>=41000 & fbpld<=41020) | fbpld==41300;
replace dadethnic=15 if fbpld==40100;
replace dadethnic=16 if fbpld==42100;
replace dadethnic=17 if (fbpld>=45300 & fbpld<=45362) | (fbpld>42100 & fbpld<=42112);
replace dadethnic=18 if fbpld>=43300 & fbpld<=43330;
replace dadethnic=19 if fbpld==45400;
replace dadethnic=20 if fbpld>=52100 & fbpld<=52150;
replace dadethnic=21 if fbpld>=41400 & fbpld<=41410;
replace dadethnic=22 if fbpld==43400;
replace dadethnic=23 if fbpld==50100;
replace dadethnic=24 if fbpld==42300;
replace dadethnic=25 if fbpld==20000;
replace dadethnic=26 if fbpld==42500;
replace dadethnic=27 if fbpld==40400;
replace dadethnic=28 if (fbpld>=50200 & fbpld<=52000) | (fbpld>=52200 & fbpld<=54000) | (fbpld<=54300 & fbpld>=59900);
replace dadethnic=30 if fbpld>=71000 & fbpld<=71050;
replace dadethnic=31 if fbpld>=45500 & fbpld<=45530;
replace dadethnic=32 if fbpld>=43600 & fbpld<=43640;
replace dadethnic=33 if fbpld>=45600 & fbpld<=45610;
replace dadethnic=34 if fbpld>=46000 & fbpld<=46590;
replace dadethnic=35 if fbpld==41100;
replace dadethnic=36 if fbpld>=30000 & fbpld<=30091;
replace dadethnic=37 if fbpld==43800;
replace dadethnic=38 if fbpld==40500;
replace dadethnic=39 if fbpld==42600;
replace dadethnic=40 if (fbpld>=53400 & fbpld<=53440) | fbpld==54100 | (fbpld>=54200 & fbpld<=54220);
replace dadethnic=41 if fbpld==41200;
replace dadethnic=42 if fbpld>=26000 & fbpld<=26095;
replace dadethnic=29 if fbpld>=15000 & fbpld<90000 & dadethnic==.;

replace ethnic=dadethnic if ethnic==.|ethnic==0;
replace ethnic=momethnic if ethnic==.|ethnic==0;

gen ethnic_small=1 if ethnic==3|ethnic==7|ethnic==14|ethnic==35|ethnic==41|ethnic==21;
replace ethnic_small=2 if ethnic==5|ethnic==8|ethnic==16;
replace ethnic_small=3 if ethnic==22|ethnic==32|ethnic==37;
replace ethnic_small=4 if ethnic==9|ethnic==12|ethnic==36|ethnic==42|ethnic==25;
replace ethnic_small=5 if ethnic==13|ethnic==15|ethnic==27|ethnic==38;
replace ethnic_small=6 if ethnic==4|ethnic==17|ethnic==39|ethnic==24|ethnic==26;
replace ethnic_small=7 if ethnic==31|ethnic==33|ethnic==34;
replace ethnic_small=8 if ethnic==19|ethnic==6|ethnic==18|ethnic==11;
replace ethnic_small=9 if ethnic==10|ethnic==20|ethnic==23|ethnic==28|ethnic==40|ethnic==1|ethnic==2|ethnic==29|ethnic==30;
replace ethnic_small=0 if ethnic==0;

gen ethnic_female=0 if bpl_female<15000;
replace ethnic_female=1 if bpl_female>=60000 & bpl_female<=60099;
replace ethnic_female=2 if bpl_female>=16000 & bpl_female<=16060;
replace ethnic_female=3 if bpl_female>=70000 & bpl_female<=70010;
replace ethnic_female=4 if bpl_female>=45000 & bpl_female<=45080;
replace ethnic_female=5 if bpl_female==42000;
replace ethnic_female=6 if (bpl_female>=45200 & bpl_female<=45212);
replace ethnic_female=7 if bpl_female>=15000 & bpl_female<=15070;
replace ethnic_female=8 if bpl_female>=15080 & bpl_female<=15083;
replace ethnic_female=8 if ethnic_female==7 & mtongue_female==11;
replace ethnic_female=9 if bpl_female>=21000 & bpl_female<=21090;
replace ethnic_female=10 if bpl_female>=50000 & bpl_female<=50040;
replace ethnic_female=11 if bpl_female==41900 | bpl_female==42200 | bpl_female==42400 | bpl_female==43000 | bpl_female==43100 | bpl_female==43200| bpl_female==43500 | bpl_female==43700 | bpl_female==44000|bpl_female==45100| (bpl_female>=45700 & bpl_female<=45900)|bpl_female==41900|bpl_female==42900|bpl_female==44000|bpl_female==49900;
replace ethnic_female=12 if bpl_female==25000;
replace ethnic_female=13 if bpl_female==40000|bpl_female==40200;
replace ethnic_female=14 if (bpl_female>=41000 & bpl_female<=41020) | bpl_female==41300;
replace ethnic_female=15 if bpl_female==40100;
replace ethnic_female=16 if bpl_female==42100;
replace ethnic_female=17 if (bpl_female>=45300 & bpl_female<=45362) | (bpl_female>42100 & bpl_female<=42112);
replace ethnic_female=18 if bpl_female>=43300 & bpl_female<=43330;
replace ethnic_female=19 if bpl_female==45400;
replace ethnic_female=20 if bpl_female>=52100 & bpl_female<=52150;
replace ethnic_female=21 if bpl_female>=41400 & bpl_female<=41410;
replace ethnic_female=22 if bpl_female==43400;
replace ethnic_female=23 if bpl_female==50100;
replace ethnic_female=24 if bpl_female==42300;
replace ethnic_female=25 if bpl_female==20000;
replace ethnic_female=26 if bpl_female==42500;
replace ethnic_female=27 if bpl_female==40400;
replace ethnic_female=28 if (bpl_female>=50200 & bpl_female<=52000) | (bpl_female>=52200 & bpl_female<=54000) | (bpl_female<=54300 & bpl_female>=59900);
replace ethnic_female=30 if bpl_female>=71000 & bpl_female<=71050;
replace ethnic_female=31 if bpl_female>=45500 & bpl_female<=45530;
replace ethnic_female=32 if bpl_female>=43600 & bpl_female<=43640;
replace ethnic_female=33 if bpl_female>=45600 & bpl_female<=45610;
replace ethnic_female=34 if bpl_female>=46000 & bpl_female<=46590;
replace ethnic_female=35 if bpl_female==41100;
replace ethnic_female=36 if bpl_female>=30000 & bpl_female<=30091;
replace ethnic_female=37 if bpl_female==43800;
replace ethnic_female=38 if bpl_female==40500;
replace ethnic_female=39 if bpl_female==42600;
replace ethnic_female=40 if (bpl_female>=53400 & bpl_female<=53440) | bpl_female==54100 | (bpl_female>=54200 & bpl_female<=54220);
replace ethnic_female=41 if bpl_female==41200;
replace ethnic_female=42 if bpl_female>=26000 & bpl_female<=26095;
replace ethnic_female=29 if bpl_female>=15000 & bpl_female<90000 & ethnic_female==.;

gen momethnic_female=0 if mbpl_female<15000;
replace momethnic_female=1 if mbpl_female>=60000 & mbpl_female<=60099;
replace momethnic_female=2 if mbpl_female>=16000 & mbpl_female<=16060;
replace momethnic_female=3 if mbpl_female>=70000 & mbpl_female<=70010;
replace momethnic_female=4 if mbpl_female>=45000 & mbpl_female<=45080;
replace momethnic_female=5 if mbpl_female==42000;
replace momethnic_female=6 if (mbpl_female>=45200 & mbpl_female<=45212);
replace momethnic_female=7 if mbpl_female>=15000 & mbpl_female<=15070;
replace momethnic_female=8 if mbpl_female>=15080 & mbpl_female<=15083;
replace momethnic_female=8 if momethnic_female==7 & mtongue_female==11;
replace momethnic_female=9 if mbpl_female>=21000 & mbpl_female<=21090;
replace momethnic_female=10 if mbpl_female>=50000 & mbpl_female<=50040;
replace momethnic_female=11 if mbpl_female==41900 | mbpl_female==42200 | mbpl_female==42400 | mbpl_female==43000 | mbpl_female==43100 | mbpl_female==43200| mbpl_female==43500 | mbpl_female==43700 | mbpl_female==44000 | mbpl_female==45100|(mbpl_female>=45700 & mbpl_female<=45900)|mbpl_female==41900|mbpl_female==42900|mbpl_female==44000|mbpl_female==49900;
replace momethnic_female=12 if mbpl_female==25000;
replace momethnic_female=13 if mbpl_female==40000|mbpl_female==40200;
replace momethnic_female=14 if (mbpl_female>=41000 & mbpl_female<=41020) | mbpl_female==41300;
replace momethnic_female=15 if mbpl_female==40100;
replace momethnic_female=16 if mbpl_female==42100;
replace momethnic_female=17 if (mbpl_female>=45300 & mbpl_female<=45362) |(mbpl_female>42100 & mbpl_female<=42112);
replace momethnic_female=18 if mbpl_female>=43300 & mbpl_female<=43330;
replace momethnic_female=19 if mbpl_female==45400;
replace momethnic_female=20 if mbpl_female>=52100 & mbpl_female<=52150;
replace momethnic_female=21 if mbpl_female>=41400 & mbpl_female<=41410;
replace momethnic_female=22 if mbpl_female==43400;
replace momethnic_female=23 if mbpl_female==50100;
replace momethnic_female=24 if mbpl_female==42300;
replace momethnic_female=25 if mbpl_female==20000;
replace momethnic_female=26 if mbpl_female==42500;
replace momethnic_female=27 if mbpl_female==40400;
replace momethnic_female=28 if (mbpl_female>=50200 & mbpl_female<=52000) | (mbpl_female>=52200 & mbpl_female<=54000) | (mbpl_female<=54300 & mbpl_female>=59900);
replace momethnic_female=30 if mbpl_female>=71000 & mbpl_female<=71050;
replace momethnic_female=31 if mbpl_female>=45500 & mbpl_female<=45530;
replace momethnic_female=32 if mbpl_female>=43600 & mbpl_female<=43640;
replace momethnic_female=33 if mbpl_female>=45600 & mbpl_female<=45610;
replace momethnic_female=34 if mbpl_female>=46000 & mbpl_female<=46590;
replace momethnic_female=35 if mbpl_female==41100;
replace momethnic_female=36 if mbpl_female>=30000 & mbpl_female<=30091;
replace momethnic_female=37 if mbpl_female==43800;
replace momethnic_female=38 if mbpl_female==40500;
replace momethnic_female=39 if mbpl_female==42600;
replace momethnic_female=40 if (mbpl_female>=53400 & mbpl_female<=53440) | mbpl_female==54100 | (mbpl_female>=54200 & mbpl_female<=54220);
replace momethnic_female=41 if mbpl_female==41200;
replace momethnic_female=42 if mbpl_female>=26000 & mbpl_female<=26095;
replace momethnic_female=29 if mbpl_female>=15000 & mbpl_female<90000 & momethnic_female==.;

gen dadethnic_female=0 if fbpl_female<15000;
replace dadethnic_female=1 if fbpl_female>=60000 & fbpl_female<=60099;
replace dadethnic_female=2 if fbpl_female>=16000 & fbpl_female<=16060;
replace dadethnic_female=3 if fbpl_female>=70000 & fbpl_female<=70010;
replace dadethnic_female=4 if fbpl_female>=45000 & fbpl_female<=45080;
replace dadethnic_female=5 if fbpl_female==42000;
replace dadethnic_female=6 if (fbpl_female>=45200 & fbpl_female<=45212);
replace dadethnic_female=7 if fbpl_female>=15000 & fbpl_female<=15070;
replace dadethnic_female=8 if fbpl_female>=15080 & fbpl_female<=15083;
replace dadethnic_female=8 if dadethnic_female==7 & mtongue_female==11;
replace dadethnic_female=9 if fbpl_female>=21000 & fbpl_female<=21090;
replace dadethnic_female=10 if fbpl_female>=50000 & fbpl_female<=50040;
replace dadethnic_female=11 if fbpl_female==41900 | fbpl_female==42200 | fbpl_female==42400 | fbpl_female==43000 | fbpl_female==43100 | fbpl_female==43200| fbpl_female==43500 | fbpl_female==43700 | fbpl_female==44000|fbpl_female==45100|(fbpl_female>=45700 & fbpl_female<=45900)|fbpl_female==41900|fbpl_female==42900|fbpl_female==44000|fbpl_female==49900;
replace dadethnic_female=12 if fbpl_female==25000;
replace dadethnic_female=13 if fbpl_female==40000|fbpl_female==40200;
replace dadethnic_female=14 if (fbpl_female>=41000 & fbpl_female<=41020) | fbpl_female==41300;
replace dadethnic_female=15 if fbpl_female==40100;
replace dadethnic_female=16 if fbpl_female==42100;
replace dadethnic_female=17 if (fbpl_female>=45300 & fbpl_female<=45362) | (fbpl_female>42100 & fbpl_female<=42112);
replace dadethnic_female=18 if fbpl_female>=43300 & fbpl_female<=43330;
replace dadethnic_female=19 if fbpl_female==45400;
replace dadethnic_female=20 if fbpl_female>=52100 & fbpl_female<=52150;
replace dadethnic_female=21 if fbpl_female>=41400 & fbpl_female<=41410;
replace dadethnic_female=22 if fbpl_female==43400;
replace dadethnic_female=23 if fbpl_female==50100;
replace dadethnic_female=24 if fbpl_female==42300;
replace dadethnic_female=25 if fbpl_female==20000;
replace dadethnic_female=26 if fbpl_female==42500;
replace dadethnic_female=27 if fbpl_female==40400;
replace dadethnic_female=28 if (fbpl_female>=50200 & fbpl_female<=52000) | (fbpl_female>=52200 & fbpl_female<=54000) | (fbpl_female<=54300 & fbpl_female>=59900);
replace dadethnic_female=30 if fbpl_female>=71000 & fbpl_female<=71050;
replace dadethnic_female=31 if fbpl_female>=45500 & fbpl_female<=45530;
replace dadethnic_female=32 if fbpl_female>=43600 & fbpl_female<=43640;
replace dadethnic_female=33 if fbpl_female>=45600 & fbpl_female<=45610;
replace dadethnic_female=34 if fbpl_female>=46000 & fbpl_female<=46590;
replace dadethnic_female=35 if fbpl_female==41100;
replace dadethnic_female=36 if fbpl_female>=30000 & fbpl_female<=30091;
replace dadethnic_female=37 if fbpl_female==43800;
replace dadethnic_female=38 if fbpl_female==40500;
replace dadethnic_female=39 if fbpl_female==42600;
replace dadethnic_female=40 if (fbpl_female>=53400 & fbpl_female<=53440) | fbpl_female==54100 | (fbpl_female>=54200 & fbpl_female<=54220);
replace dadethnic_female=41 if fbpl_female==41200;
replace dadethnic_female=42 if fbpl_female>=26000 & fbpl_female<=26095;
replace dadethnic_female=29 if fbpl_female>=15000 & fbpl_female<90000 & dadethnic_female==.;

replace ethnic_female=dadethnic_female if ethnic_female==.|ethnic_female==0;
replace ethnic_female=momethnic_female if ethnic_female==.|ethnic_female==0;

gen ethnic_small_female=1 if ethnic_female==3|ethnic_female==7|ethnic_female==14|ethnic_female==35|ethnic_female==41|ethnic_female==21;
replace ethnic_small_female=2 if ethnic_female==5|ethnic_female==8|ethnic_female==16;
replace ethnic_small_female=3 if ethnic_female==22|ethnic_female==32|ethnic_female==37;
replace ethnic_small_female=4 if ethnic_female==9|ethnic_female==12|ethnic_female==36|ethnic_female==42|ethnic_female==25;
replace ethnic_small_female=5 if ethnic_female==13|ethnic_female==15|ethnic_female==27|ethnic_female==38;
replace ethnic_small_female=6 if ethnic_female==4|ethnic_female==17|ethnic_female==39|ethnic_female==24|ethnic_female==26;
replace ethnic_small_female=7 if ethnic_female==31|ethnic_female==33|ethnic_female==34;
replace ethnic_small_female=8 if ethnic_female==19|ethnic_female==6|ethnic_female==18|ethnic_female==11;
replace ethnic_small_female=9 if ethnic_female==10|ethnic_female==20|ethnic_female==23|ethnic_female==28|ethnic_female==40|ethnic_female==1|ethnic_female==2|ethnic_female==29|ethnic_female==30;
replace ethnic_small_female=0 if ethnic_female==0;

gen immig_female=bpl_female>=15000 if bpl_female<=90000 & bpl_female~=0 & bpld<15000;
gen sameethnic=ethnic_small==ethnic_small_female if ethnic_small_female~=. & bpld<15000;
gen immig_same_female=immig_female*sameethnic;
gen otherethnic=(ethnic_small~=ethnic_small_female & ethnic_small_female~=0) if ethnic_female~=. & bpld<15000;
gen native=ethnic_female==0 if ethnic_female~=. & bpld<15000;
gen educ_immig_male=higrade if bpld>=15000 & bpld<90000;
gen samecountry=ethnic==ethnic_female if ethnic_female~=. & bpld<15000;

gen stock_male=1;
gen married_male=ethnic_female~=. & bpld<15000;
gen divorced_male=marst==4;
gen evermarried_male=1-(marst==6);

collapse (sum)divorced_male (sum)evermarried_male (sum)stock_male (sum)married_male (mean)educ_immig_male (mean)samecountry (mean)sameethnic (mean)immig_female (mean)immig_same_female (mean)otherethnic (mean)native (mean)higrade, by(ethnic ethnic_small);
rename samecountry samecountry_female;
rename sameethnic sameethnic_female;
rename otherethnic otherethnic_female;
rename native native_female;
rename higrade higrade_male;
gen divorce_rate_male=divorced_male/evermarried_male;
drop divorced_male evermarried_male;
sort ethnic;
merge ethnic using characteristics_ethnic;
tab _merge;
drop _merge;
drop if ethnic==.;

*Generate a measure of endogamy comparing the fraction of individuals marrying within their ethnic group to that of spousal availability;
egen all_male=total(stock_male);
egen all_female=total(stock_female);
bysort ethnic_small: egen own_male=total(stock_male);
bysort ethnic_small: egen own_female=total(stock_female);
gen diff_endogamy_male=sameethnic_female-(own_female/all_female);
gen diff_endogamy_female=sameethnic_male-(own_male/all_male);
drop own_* all_* ethnic_small;

*Generate a measure of the difference between education of own group and that of natives;
gen higrade_male_nat=higrade_male if ethnic==0;
gen higrade_female_nat=higrade_female if ethnic==0;
egen nat_grade_male=mean(higrade_male_nat);
egen nat_grade_female=mean(higrade_female_nat);
gen diff_grade_male=higrade_male-nat_grade_male;
gen diff_grade_female=higrade_female-nat_grade_female;
drop nat_* *_nat;

rename stock_male size_group_male;
rename stock_female size_group_female;
rename sameethnic_female endogamy_female;
rename sameethnic_male endogamy_male;
rename immig_female marryimmig_female;
rename immig_male marryimmig_male;
rename immig_same_female endog_immig_female;
rename immig_same_male endog_immig_male;
rename otherethnic_female exog_female;
rename otherethnic_male exog_male;
rename higrade_male avg_educ_male;
rename higrade_female avg_educ_female;
rename native_male exog_native_male;
rename native_female exog_native_female;
sort ethnic;
save characteristics_ethnic, replace;


*Now build the data of outcomes for second generation females;

use outcomes_females;
drop if age<15;
keep if yob>=1885 & yob<1915;
drop if bpld>=15000 & bpld<=90000;

*Classify their mother and father into the ethnicities of Table C1;

gen momethnic=0 if mbpld<15000;
replace momethnic=1 if mbpld>=60000 & mbpld<=60099;
replace momethnic=2 if mbpld>=16000 & mbpld<=16060;
replace momethnic=3 if mbpld>=70000 & mbpld<=70010;
replace momethnic=4 if mbpld>=45000 & mbpld<=45080;
replace momethnic=5 if mbpld==42000;
replace momethnic=6 if (mbpld>=45200 & mbpld<=45212);
replace momethnic=7 if mbpld>=15000 & mbpld<=15070;
replace momethnic=8 if mbpld>=15080 & mbpld<=15083;
replace momethnic=8 if momethnic==7 & mtongue==11;
replace momethnic=9 if mbpld>=21000 & mbpld<=21090;
replace momethnic=10 if mbpld>=50000 & mbpld<=50040;
replace momethnic=11 if mbpld==41900 | mbpld==42200 | mbpld==42400 | mbpld==43000 | mbpld==43100 | mbpld==43200| mbpld==43500 | mbpld==43700 | mbpld==44000 | mbpld==45100|(mbpld>=45700 & mbpld<=45900)|mbpld==41900|mbpld==42900|mbpld==44000|mbpld==49900;
replace momethnic=12 if mbpld==25000;
replace momethnic=13 if mbpld==40000|mbpld==40200;
replace momethnic=14 if (mbpld>=41000 & mbpld<=41020) | mbpld==41300;
replace momethnic=15 if mbpld==40100;
replace momethnic=16 if mbpld==42100;
replace momethnic=17 if (mbpld>=45300 & mbpld<=45362) |(mbpld>42100 & mbpld<=42112);
replace momethnic=18 if mbpld>=43300 & mbpld<=43330;
replace momethnic=19 if mbpld==45400;
replace momethnic=20 if mbpld>=52100 & mbpld<=52150;
replace momethnic=21 if mbpld>=41400 & mbpld<=41410;
replace momethnic=22 if mbpld==43400;
replace momethnic=23 if mbpld==50100;
replace momethnic=24 if mbpld==42300;
replace momethnic=25 if mbpld==20000;
replace momethnic=26 if mbpld==42500;
replace momethnic=27 if mbpld==40400;
replace momethnic=28 if (mbpld>=50200 & mbpld<=52000) | (mbpld>=52200 & mbpld<=54000) | (mbpld<=54300 & mbpld>=59900);
replace momethnic=30 if mbpld>=71000 & mbpld<=71050;
replace momethnic=31 if mbpld>=45500 & mbpld<=45530;
replace momethnic=32 if mbpld>=43600 & mbpld<=43640;
replace momethnic=33 if mbpld>=45600 & mbpld<=45610;
replace momethnic=34 if mbpld>=46000 & mbpld<=46590;
replace momethnic=35 if mbpld==41100;
replace momethnic=36 if mbpld>=30000 & mbpld<=30091;
replace momethnic=37 if mbpld==43800;
replace momethnic=38 if mbpld==40500;
replace momethnic=39 if mbpld==42600;
replace momethnic=40 if (mbpld>=53400 & mbpld<=53440) | mbpld==54100 | (mbpld>=54200 & mbpld<=54220);
replace momethnic=41 if mbpld==41200;
replace momethnic=42 if mbpld>=26000 & mbpld<=26095;
replace momethnic=29 if mbpld>=15000 & mbpld<90000 & momethnic==.;

gen dadethnic=0 if fbpld<15000;
replace dadethnic=1 if fbpld>=60000 & fbpld<=60099;
replace dadethnic=2 if fbpld>=16000 & fbpld<=16060;
replace dadethnic=3 if fbpld>=70000 & fbpld<=70010;
replace dadethnic=4 if fbpld>=45000 & fbpld<=45080;
replace dadethnic=5 if fbpld==42000;
replace dadethnic=6 if (fbpld>=45200 & fbpld<=45212);
replace dadethnic=7 if fbpld>=15000 & fbpld<=15070;
replace dadethnic=8 if fbpld>=15080 & fbpld<=15083;
replace dadethnic=8 if dadethnic==7 & mtongue==11;
replace dadethnic=9 if fbpld>=21000 & fbpld<=21090;
replace dadethnic=10 if fbpld>=50000 & fbpld<=50040;
replace dadethnic=11 if fbpld==41900 | fbpld==42200 | fbpld==42400 | fbpld==43000 | fbpld==43100 | fbpld==43200| fbpld==43500 | fbpld==43700 | fbpld==44000|fbpld==45100|(fbpld>=45700 & fbpld<=45900)|fbpld==41900|fbpld==42900|fbpld==44000|fbpld==49900;
replace dadethnic=12 if fbpld==25000;
replace dadethnic=13 if fbpld==40000|fbpld==40200;
replace dadethnic=14 if (fbpld>=41000 & fbpld<=41020) | fbpld==41300;
replace dadethnic=15 if fbpld==40100;
replace dadethnic=16 if fbpld==42100;
replace dadethnic=17 if (fbpld>=45300 & fbpld<=45362) | (fbpld>42100 & fbpld<=42112);
replace dadethnic=18 if fbpld>=43300 & fbpld<=43330;
replace dadethnic=19 if fbpld==45400;
replace dadethnic=20 if fbpld>=52100 & fbpld<=52150;
replace dadethnic=21 if fbpld>=41400 & fbpld<=41410;
replace dadethnic=22 if fbpld==43400;
replace dadethnic=23 if fbpld==50100;
replace dadethnic=24 if fbpld==42300;
replace dadethnic=25 if fbpld==20000;
replace dadethnic=26 if fbpld==42500;
replace dadethnic=27 if fbpld==40400;
replace dadethnic=28 if (fbpld>=50200 & fbpld<=52000) | (fbpld>=52200 & fbpld<=54000) | (fbpld<=54300 & fbpld>=59900);
replace dadethnic=30 if fbpld>=71000 & fbpld<=71050;
replace dadethnic=31 if fbpld>=45500 & fbpld<=45530;
replace dadethnic=32 if fbpld>=43600 & fbpld<=43640;
replace dadethnic=33 if fbpld>=45600 & fbpld<=45610;
replace dadethnic=34 if fbpld>=46000 & fbpld<=46590;
replace dadethnic=35 if fbpld==41100;
replace dadethnic=36 if fbpld>=30000 & fbpld<=30091;
replace dadethnic=37 if fbpld==43800;
replace dadethnic=38 if fbpld==40500;
replace dadethnic=39 if fbpld==42600;
replace dadethnic=40 if (fbpld>=53400 & fbpld<=53440) | fbpld==54100 | (fbpld>=54200 & fbpld<=54220);
replace dadethnic=41 if fbpld==41200;
replace dadethnic=42 if fbpld>=26000 & fbpld<=26095;
replace dadethnic=29 if fbpld>=15000 & fbpld<90000 & dadethnic==.;

gen ethnic=dadethnic;
replace ethnic=momethnic if ethnic==.|ethnic==0;

gen ethnic_small=1 if ethnic==3|ethnic==7|ethnic==14|ethnic==35|ethnic==41|ethnic==21;
replace ethnic_small=2 if ethnic==5|ethnic==8|ethnic==16;
replace ethnic_small=3 if ethnic==22|ethnic==32|ethnic==37;
replace ethnic_small=4 if ethnic==9|ethnic==12|ethnic==36|ethnic==42|ethnic==25;
replace ethnic_small=5 if ethnic==13|ethnic==15|ethnic==27|ethnic==38;
replace ethnic_small=6 if ethnic==4|ethnic==17|ethnic==39|ethnic==24|ethnic==26;
replace ethnic_small=7 if ethnic==31|ethnic==33|ethnic==34;
replace ethnic_small=8 if ethnic==19|ethnic==6|ethnic==18|ethnic==11;
replace ethnic_small=9 if ethnic==10|ethnic==20|ethnic==23|ethnic==28|ethnic==40|ethnic==1|ethnic==2|ethnic==29|ethnic==30;
replace ethnic_small=0 if ethnic==0;

gen motherforeign=nativity==3|nativity==4;
gen fatherforeign=nativity==2|nativity==4;
replace motherforeign=1 if mbpld>=15000 & mbpld<=90000;
replace fatherforeign=1 if fbpld>=15000 & fbpld<=90000;
drop if motherforeign==0 & fatherforeign==0;

gen ethnic_male=0 if bpl_male<15000;
replace ethnic_male=1 if bpl_male>=60000 & bpl_male<=60099;
replace ethnic_male=2 if bpl_male>=16000 & bpl_male<=16060;
replace ethnic_male=3 if bpl_male>=70000 & bpl_male<=70010;
replace ethnic_male=4 if bpl_male>=45000 & bpl_male<=45080;
replace ethnic_male=5 if bpl_male==42000;
replace ethnic_male=6 if (bpl_male>=45200 & bpl_male<=45212);
replace ethnic_male=7 if bpl_male>=15000 & bpl_male<=15070;
replace ethnic_male=8 if bpl_male>=15080 & bpl_male<=15083;
replace ethnic_male=8 if ethnic_male==7 & mtongue_male==11;
replace ethnic_male=9 if bpl_male>=21000 & bpl_male<=21090;
replace ethnic_male=10 if bpl_male>=50000 & bpl_male<=50040;
replace ethnic_male=11 if bpl_male==41900 | bpl_male==42200 | bpl_male==42400 | bpl_male==43000 | bpl_male==43100 | bpl_male==43200| bpl_male==43500 | bpl_male==43700 | bpl_male==44000|bpl_male==45100| (bpl_male>=45700 & bpl_male<=45900)|bpl_male==41900|bpl_male==42900|bpl_male==44000|bpl_male==49900;
replace ethnic_male=12 if bpl_male==25000;
replace ethnic_male=13 if bpl_male==40000|bpl_male==40200;
replace ethnic_male=14 if (bpl_male>=41000 & bpl_male<=41020) | bpl_male==41300;
replace ethnic_male=15 if bpl_male==40100;
replace ethnic_male=16 if bpl_male==42100;
replace ethnic_male=17 if (bpl_male>=45300 & bpl_male<=45362) | (bpl_male>42100 & bpl_male<=42112);
replace ethnic_male=18 if bpl_male>=43300 & bpl_male<=43330;
replace ethnic_male=19 if bpl_male==45400;
replace ethnic_male=20 if bpl_male>=52100 & bpl_male<=52150;
replace ethnic_male=21 if bpl_male>=41400 & bpl_male<=41410;
replace ethnic_male=22 if bpl_male==43400;
replace ethnic_male=23 if bpl_male==50100;
replace ethnic_male=24 if bpl_male==42300;
replace ethnic_male=25 if bpl_male==20000;
replace ethnic_male=26 if bpl_male==42500;
replace ethnic_male=27 if bpl_male==40400;
replace ethnic_male=28 if (bpl_male>=50200 & bpl_male<=52000) | (bpl_male>=52200 & bpl_male<=54000) | (bpl_male<=54300 & bpl_male>=59900);
replace ethnic_male=30 if bpl_male>=71000 & bpl_male<=71050;
replace ethnic_male=31 if bpl_male>=45500 & bpl_male<=45530;
replace ethnic_male=32 if bpl_male>=43600 & bpl_male<=43640;
replace ethnic_male=33 if bpl_male>=45600 & bpl_male<=45610;
replace ethnic_male=34 if bpl_male>=46000 & bpl_male<=46590;
replace ethnic_male=35 if bpl_male==41100;
replace ethnic_male=36 if bpl_male>=30000 & bpl_male<=30091;
replace ethnic_male=37 if bpl_male==43800;
replace ethnic_male=38 if bpl_male==40500;
replace ethnic_male=39 if bpl_male==42600;
replace ethnic_male=40 if (bpl_male>=53400 & bpl_male<=53440) | bpl_male==54100 | (bpl_male>=54200 & bpl_male<=54220);
replace ethnic_male=41 if bpl_male==41200;
replace ethnic_male=42 if bpl_male>=26000 & bpl_male<=26095;
replace ethnic_male=29 if bpl_male>=15000 & bpl_male<90000 & ethnic_male==.;

gen momethnic_male=0 if mbpl_male<15000;
replace momethnic_male=1 if mbpl_male>=60000 & mbpl_male<=60099;
replace momethnic_male=2 if mbpl_male>=16000 & mbpl_male<=16060;
replace momethnic_male=3 if mbpl_male>=70000 & mbpl_male<=70010;
replace momethnic_male=4 if mbpl_male>=45000 & mbpl_male<=45080;
replace momethnic_male=5 if mbpl_male==42000;
replace momethnic_male=6 if (mbpl_male>=45200 & mbpl_male<=45212);
replace momethnic_male=7 if mbpl_male>=15000 & mbpl_male<=15070;
replace momethnic_male=8 if mbpl_male>=15080 & mbpl_male<=15083;
replace momethnic_male=8 if momethnic_male==7 & mtongue_male==11;
replace momethnic_male=9 if mbpl_male>=21000 & mbpl_male<=21090;
replace momethnic_male=10 if mbpl_male>=50000 & mbpl_male<=50040;
replace momethnic_male=11 if mbpl_male==41900 | mbpl_male==42200 | mbpl_male==42400 | mbpl_male==43000 | mbpl_male==43100 | mbpl_male==43200| mbpl_male==43500 | mbpl_male==43700 | mbpl_male==44000 | mbpl_male==45100|(mbpl_male>=45700 & mbpl_male<=45900)|mbpl_male==41900|mbpl_male==42900|mbpl_male==44000|mbpl_male==49900;
replace momethnic_male=12 if mbpl_male==25000;
replace momethnic_male=13 if mbpl_male==40000|mbpl_male==40200;
replace momethnic_male=14 if (mbpl_male>=41000 & mbpl_male<=41020) | mbpl_male==41300;
replace momethnic_male=15 if mbpl_male==40100;
replace momethnic_male=16 if mbpl_male==42100;
replace momethnic_male=17 if (mbpl_male>=45300 & mbpl_male<=45362) |(mbpl_male>42100 & mbpl_male<=42112);
replace momethnic_male=18 if mbpl_male>=43300 & mbpl_male<=43330;
replace momethnic_male=19 if mbpl_male==45400;
replace momethnic_male=20 if mbpl_male>=52100 & mbpl_male<=52150;
replace momethnic_male=21 if mbpl_male>=41400 & mbpl_male<=41410;
replace momethnic_male=22 if mbpl_male==43400;
replace momethnic_male=23 if mbpl_male==50100;
replace momethnic_male=24 if mbpl_male==42300;
replace momethnic_male=25 if mbpl_male==20000;
replace momethnic_male=26 if mbpl_male==42500;
replace momethnic_male=27 if mbpl_male==40400;
replace momethnic_male=28 if (mbpl_male>=50200 & mbpl_male<=52000) | (mbpl_male>=52200 & mbpl_male<=54000) | (mbpl_male<=54300 & mbpl_male>=59900);
replace momethnic_male=30 if mbpl_male>=71000 & mbpl_male<=71050;
replace momethnic_male=31 if mbpl_male>=45500 & mbpl_male<=45530;
replace momethnic_male=32 if mbpl_male>=43600 & mbpl_male<=43640;
replace momethnic_male=33 if mbpl_male>=45600 & mbpl_male<=45610;
replace momethnic_male=34 if mbpl_male>=46000 & mbpl_male<=46590;
replace momethnic_male=35 if mbpl_male==41100;
replace momethnic_male=36 if mbpl_male>=30000 & mbpl_male<=30091;
replace momethnic_male=37 if mbpl_male==43800;
replace momethnic_male=38 if mbpl_male==40500;
replace momethnic_male=39 if mbpl_male==42600;
replace momethnic_male=40 if (mbpl_male>=53400 & mbpl_male<=53440) | mbpl_male==54100 | (mbpl_male>=54200 & mbpl_male<=54220);
replace momethnic_male=41 if mbpl_male==41200;
replace momethnic_male=42 if mbpl_male>=26000 & mbpl_male<=26095;
replace momethnic_male=29 if mbpl_male>=15000 & mbpl_male<90000 & momethnic_male==.;

gen dadethnic_male=0 if fbpl_male<15000;
replace dadethnic_male=1 if fbpl_male>=60000 & fbpl_male<=60099;
replace dadethnic_male=2 if fbpl_male>=16000 & fbpl_male<=16060;
replace dadethnic_male=3 if fbpl_male>=70000 & fbpl_male<=70010;
replace dadethnic_male=4 if fbpl_male>=45000 & fbpl_male<=45080;
replace dadethnic_male=5 if fbpl_male==42000;
replace dadethnic_male=6 if (fbpl_male>=45200 & fbpl_male<=45212);
replace dadethnic_male=7 if fbpl_male>=15000 & fbpl_male<=15070;
replace dadethnic_male=8 if fbpl_male>=15080 & fbpl_male<=15083;
replace dadethnic_male=8 if dadethnic_male==7 & mtongue_male==11;
replace dadethnic_male=9 if fbpl_male>=21000 & fbpl_male<=21090;
replace dadethnic_male=10 if fbpl_male>=50000 & fbpl_male<=50040;
replace dadethnic_male=11 if fbpl_male==41900 | fbpl_male==42200 | fbpl_male==42400 | fbpl_male==43000 | fbpl_male==43100 | fbpl_male==43200| fbpl_male==43500 | fbpl_male==43700 | fbpl_male==44000|fbpl_male==45100|(fbpl_male>=45700 & fbpl_male<=45900)|fbpl_male==41900|fbpl_male==42900|fbpl_male==44000|fbpl_male==49900;
replace dadethnic_male=12 if fbpl_male==25000;
replace dadethnic_male=13 if fbpl_male==40000|fbpl_male==40200;
replace dadethnic_male=14 if (fbpl_male>=41000 & fbpl_male<=41020) | fbpl_male==41300;
replace dadethnic_male=15 if fbpl_male==40100;
replace dadethnic_male=16 if fbpl_male==42100;
replace dadethnic_male=17 if (fbpl_male>=45300 & fbpl_male<=45362) | (fbpl_male>42100 & fbpl_male<=42112);
replace dadethnic_male=18 if fbpl_male>=43300 & fbpl_male<=43330;
replace dadethnic_male=19 if fbpl_male==45400;
replace dadethnic_male=20 if fbpl_male>=52100 & fbpl_male<=52150;
replace dadethnic_male=21 if fbpl_male>=41400 & fbpl_male<=41410;
replace dadethnic_male=22 if fbpl_male==43400;
replace dadethnic_male=23 if fbpl_male==50100;
replace dadethnic_male=24 if fbpl_male==42300;
replace dadethnic_male=25 if fbpl_male==20000;
replace dadethnic_male=26 if fbpl_male==42500;
replace dadethnic_male=27 if fbpl_male==40400;
replace dadethnic_male=28 if (fbpl_male>=50200 & fbpl_male<=52000) | (fbpl_male>=52200 & fbpl_male<=54000) | (fbpl_male<=54300 & fbpl_male>=59900);
replace dadethnic_male=30 if fbpl_male>=71000 & fbpl_male<=71050;
replace dadethnic_male=31 if fbpl_male>=45500 & fbpl_male<=45530;
replace dadethnic_male=32 if fbpl_male>=43600 & fbpl_male<=43640;
replace dadethnic_male=33 if fbpl_male>=45600 & fbpl_male<=45610;
replace dadethnic_male=34 if fbpl_male>=46000 & fbpl_male<=46590;
replace dadethnic_male=35 if fbpl_male==41100;
replace dadethnic_male=36 if fbpl_male>=30000 & fbpl_male<=30091;
replace dadethnic_male=37 if fbpl_male==43800;
replace dadethnic_male=38 if fbpl_male==40500;
replace dadethnic_male=39 if fbpl_male==42600;
replace dadethnic_male=40 if (fbpl_male>=53400 & fbpl_male<=53440) | fbpl_male==54100 | (fbpl_male>=54200 & fbpl_male<=54220);
replace dadethnic_male=41 if fbpl_male==41200;
replace dadethnic_male=42 if fbpl_male>=26000 & fbpl_male<=26095;
replace dadethnic_male=29 if fbpl_male>=15000 & fbpl_male<90000 & dadethnic_male==.;

replace ethnic_male=dadethnic_male if ethnic_male==.|ethnic_male==0;
replace ethnic_male=momethnic_male if ethnic_male==.|ethnic_male==0;

gen ethnic_small_male=1 if ethnic_male==3|ethnic_male==7|ethnic_male==14|ethnic_male==35|ethnic_male==41|ethnic_male==21;
replace ethnic_small_male=2 if ethnic_male==5|ethnic_male==8|ethnic_male==16;
replace ethnic_small_male=3 if ethnic_male==22|ethnic_male==32|ethnic_male==37;
replace ethnic_small_male=4 if ethnic_male==9|ethnic_male==12|ethnic_male==36|ethnic_male==42|ethnic_male==25;
replace ethnic_small_male=5 if ethnic_male==13|ethnic_male==15|ethnic_male==27|ethnic_male==38;
replace ethnic_small_male=6 if ethnic_male==4|ethnic_male==17|ethnic_male==39|ethnic_male==24|ethnic_male==26;
replace ethnic_small_male=7 if ethnic_male==31|ethnic_male==33|ethnic_male==34;
replace ethnic_small_male=8 if ethnic_male==19|ethnic_male==6|ethnic_male==18|ethnic_male==11;
replace ethnic_small_male=9 if ethnic_male==10|ethnic_male==20|ethnic_male==23|ethnic_male==28|ethnic_male==40|ethnic_male==1|ethnic_male==2|ethnic_male==29|ethnic_male==30;
replace ethnic_small_male=0 if ethnic_male==0;

gen immig_male=bpl_male>=15000 if bpl_male<=90000;
replace immig_male=0 if marst~=1;

*Generate variables classifying the match as being endogamous or exogamous;
gen sameethnic=ethnic_small==ethnic_small_male if ethnic_male~=.;
replace sameethnic=0 if marst~=1 & sameethnic==.;
replace sameethnic=. if year==1940|year==1950;
gen immig_same_male=immig_male*sameethnic;
gen otherethnic=(ethnic_small~=ethnic_small_male & ethnic_small_male~=0) if ethnic_male~=.;
replace otherethnic=0 if marst~=1 & otherethnic==.;
replace otherethnic=. if year==1940|year==1950;
gen native=ethnic_male==0 if ethnic_male~=.;
replace native=0 if marst~=1 & native==.;
replace native=. if year==1940|year==1950;

gen period_imm=(5*floor(yob/5))+15;
drop if period_imm<1900 | period_imm>=1930;

gen state=statefip;
replace state=floor(bpld/100) if bpld<15000;
replace state=state-1 if state>=4;
replace state=state-1 if state>=7;
replace state=state-1 if state>=13;
replace state=state-1 if state>=41;
replace state=state-1 if state>=49;
drop if state>51;

gen state_male=statefip_male;
replace state_male=floor(bpl_male/100) if bpl_male<15000;
replace state_male=state_male-1 if state_male>=4;
replace state_male=state_male-1 if state_male>=7;
replace state_male=state_male-1 if state_male>=13;
replace state_male=state_male-1 if state_male>=41;
replace state_male=state_male-1 if state_male>=49;

replace statefip=statefip-1 if statefip>=4;
replace statefip=statefip-1 if statefip>=7;
replace statefip=statefip-1 if statefip>=13;
replace statefip=statefip-1 if statefip>=41;
replace statefip=statefip-1 if statefip>=49;

gen samestate=state==state_male if marst==1;

*Merge the outcomes with the sex ratio data;

sort ethnic_small period_imm state;
merge ethnic_small period_imm state using instrument;
tab _merge;
drop _merge;

*Build the human capital variables;

replace lit=. if lit==0;
replace lit=0 if lit<=3;
replace lit=1 if lit==4;

replace lit_male=. if lit_male==0;
replace lit_male=0 if lit_male<=3;
replace lit_male=1 if lit_male==4;
replace lit_male=0 if marst~=1 & year<=1930;

replace higrade_male=. if higrade_male==0;
replace higrade=. if higrade==0;
replace higrade=higrade-3;
replace higrade=0 if higrade<0;
replace higrade_male=higrade_male-3;
replace higrade_male=0 if higrade_male<0;
gen higrade_male_all=higrade_male;
replace higrade_male_all=0 if higrade_male==. & year>1930 & year~=1950;

replace edscor50=0 if edscor50==9999;

*Build marital outcomes;

replace agemarr=. if agemarr<10;
gen nevermarr=marst==6;
gen stillmarried=marst==1|marst==2|marst==3;
gen marriedtwice=(marrno>=2 & marrno<=6) if marrno<=6;
gen livingwith=marst==1;
gen divorced=marst==4;
gen widowed=marst==5;

*Build labor supply outcomes;
gen employed=empstat==1 if year~=1920;
gen inlf=labforce==2;
replace wkswork2=. if labforce==2 & wkswork2==0;
replace hrswork2=. if empstat==1 & hrswork2==0;
gen weeks=0 if wkswork2==0;
replace weeks=6.5 if wkswork2==1;
replace weeks=20 if wkswork2==2;
replace weeks=33 if wkswork2==3;
replace weeks=44 if wkswork2==4;
replace weeks=48.5 if wkswork2==5;
replace weeks=51 if wkswork2==6;

gen hours=0 if hrswork2==0;
replace hours=7 if hrswork2==1;
replace hours=22 if hrswork2==2;
replace hours=32 if hrswork2==3;
replace hours=37 if hrswork2==4;
replace hours=40 if hrswork2==5;
replace hours=44 if hrswork2==6;
replace hours=55 if hrswork2==7;
replace hours=65 if hrswork2==8;

compress;
sort ethnic;
merge ethnic using characteristics_ethnic;
tab _merge;
drop _merge;

gen logsex2=log(sexratio_imm_young);
replace logsex2=. if female_imm==0|male_imm==0;
gen logpredsex2=log(pred_sexratio_imm);
gen logpredstock2=log(pred_imm);
gen logstock2=log(stock_imm_young);


*Demeaning the characteristics to facilitate the interpretation of the interaction terms;
egen mean_diff_grade=mean(diff_grade_male);
egen mean_diff_endog=mean(diff_endogamy_female);

replace diff_grade_male=diff_grade_male-mean_diff_grade;
replace diff_endogamy_female=diff_endogamy_female-mean_diff_endog;
drop mean_diff_grade mean_diff_endog;

gen inter_educ=sexratio_imm_young*diff_grade_male;
gen inter_educ_iv=pred_sexratio_imm*diff_grade_male;
gen inter_endog=sexratio_imm_young*diff_endogamy_female;
gen inter_endog_iv=pred_sexratio_imm*diff_endogamy_female;
gen inter_div=sexratio_imm_young*divorce_rate_female;
gen inter_div_iv=pred_sexratio_imm*divorce_rate_female;

gen inter_educ_tot=sexratio_tot*diff_grade_male;
gen inter_educ_tot_iv=pred_sexratio_total*diff_grade_male;
gen inter_endog_tot=sexratio_tot*diff_endogamy_female;
gen inter_endog_tot_iv=pred_sexratio_total*diff_endogamy_female;
gen inter_div_tot=sexratio_tot*divorce_rate_female;
gen inter_div_tot_iv=pred_sexratio_total*divorce_rate_female;

save final_females, replace;

use outcomes_males;
drop if age<15;
keep if yob>=1885 & yob<1920;
drop if bpld>=15000 & bpld<=90000;
gen period_imm=(5*floor(yob/5))+15;
drop if period_imm<1900 | period_imm>=1930;

gen motherforeign=nativity==3|nativity==4;
gen fatherforeign=nativity==2|nativity==4;
replace motherforeign=1 if mbpld>=15000 & mbpld<=90000;
replace fatherforeign=1 if fbpld>=15000 & fbpld<=90000;
drop if motherforeign==0 & fatherforeign==0;

gen momethnic=0 if mbpld<15000;
replace momethnic=1 if mbpld>=60000 & mbpld<=60099;
replace momethnic=2 if mbpld>=16000 & mbpld<=16060;
replace momethnic=3 if mbpld>=70000 & mbpld<=70010;
replace momethnic=4 if mbpld>=45000 & mbpld<=45080;
replace momethnic=5 if mbpld==42000;
replace momethnic=6 if (mbpld>=45200 & mbpld<=45212);
replace momethnic=7 if mbpld>=15000 & mbpld<=15070;
replace momethnic=8 if mbpld>=15080 & mbpld<=15083;
replace momethnic=8 if momethnic==7 & mtongue==11;
replace momethnic=9 if mbpld>=21000 & mbpld<=21090;
replace momethnic=10 if mbpld>=50000 & mbpld<=50040;
replace momethnic=11 if mbpld==41900 | mbpld==42200 | mbpld==42400 | mbpld==43000 | mbpld==43100 | mbpld==43200| mbpld==43500 | mbpld==43700 | mbpld==44000 | mbpld==45100|(mbpld>=45700 & mbpld<=45900)|mbpld==41900|mbpld==42900|mbpld==44000|mbpld==49900;
replace momethnic=12 if mbpld==25000;
replace momethnic=13 if mbpld==40000|mbpld==40200;
replace momethnic=14 if (mbpld>=41000 & mbpld<=41020) | mbpld==41300;
replace momethnic=15 if mbpld==40100;
replace momethnic=16 if mbpld==42100;
replace momethnic=17 if (mbpld>=45300 & mbpld<=45362) |(mbpld>42100 & mbpld<=42112);
replace momethnic=18 if mbpld>=43300 & mbpld<=43330;
replace momethnic=19 if mbpld==45400;
replace momethnic=20 if mbpld>=52100 & mbpld<=52150;
replace momethnic=21 if mbpld>=41400 & mbpld<=41410;
replace momethnic=22 if mbpld==43400;
replace momethnic=23 if mbpld==50100;
replace momethnic=24 if mbpld==42300;
replace momethnic=25 if mbpld==20000;
replace momethnic=26 if mbpld==42500;
replace momethnic=27 if mbpld==40400;
replace momethnic=28 if (mbpld>=50200 & mbpld<=52000) | (mbpld>=52200 & mbpld<=54000) | (mbpld<=54300 & mbpld>=59900);
replace momethnic=30 if mbpld>=71000 & mbpld<=71050;
replace momethnic=31 if mbpld>=45500 & mbpld<=45530;
replace momethnic=32 if mbpld>=43600 & mbpld<=43640;
replace momethnic=33 if mbpld>=45600 & mbpld<=45610;
replace momethnic=34 if mbpld>=46000 & mbpld<=46590;
replace momethnic=35 if mbpld==41100;
replace momethnic=36 if mbpld>=30000 & mbpld<=30091;
replace momethnic=37 if mbpld==43800;
replace momethnic=38 if mbpld==40500;
replace momethnic=39 if mbpld==42600;
replace momethnic=40 if (mbpld>=53400 & mbpld<=53440) | mbpld==54100 | (mbpld>=54200 & mbpld<=54220);
replace momethnic=41 if mbpld==41200;
replace momethnic=42 if mbpld>=26000 & mbpld<=26095;
replace momethnic=29 if mbpld>=15000 & mbpld<90000 & momethnic==.;

gen dadethnic=0 if fbpld<15000;
replace dadethnic=1 if fbpld>=60000 & fbpld<=60099;
replace dadethnic=2 if fbpld>=16000 & fbpld<=16060;
replace dadethnic=3 if fbpld>=70000 & fbpld<=70010;
replace dadethnic=4 if fbpld>=45000 & fbpld<=45080;
replace dadethnic=5 if fbpld==42000;
replace dadethnic=6 if (fbpld>=45200 & fbpld<=45212);
replace dadethnic=7 if fbpld>=15000 & fbpld<=15070;
replace dadethnic=8 if fbpld>=15080 & fbpld<=15083;
replace dadethnic=8 if dadethnic==7 & mtongue==11;
replace dadethnic=9 if fbpld>=21000 & fbpld<=21090;
replace dadethnic=10 if fbpld>=50000 & fbpld<=50040;
replace dadethnic=11 if fbpld==41900 | fbpld==42200 | fbpld==42400 | fbpld==43000 | fbpld==43100 | fbpld==43200| fbpld==43500 | fbpld==43700 | fbpld==44000|fbpld==45100|(fbpld>=45700 & fbpld<=45900)|fbpld==41900|fbpld==42900|fbpld==44000|fbpld==49900;
replace dadethnic=12 if fbpld==25000;
replace dadethnic=13 if fbpld==40000|fbpld==40200;
replace dadethnic=14 if (fbpld>=41000 & fbpld<=41020) | fbpld==41300;
replace dadethnic=15 if fbpld==40100;
replace dadethnic=16 if fbpld==42100;
replace dadethnic=17 if (fbpld>=45300 & fbpld<=45362) | (fbpld>42100 & fbpld<=42112);
replace dadethnic=18 if fbpld>=43300 & fbpld<=43330;
replace dadethnic=19 if fbpld==45400;
replace dadethnic=20 if fbpld>=52100 & fbpld<=52150;
replace dadethnic=21 if fbpld>=41400 & fbpld<=41410;
replace dadethnic=22 if fbpld==43400;
replace dadethnic=23 if fbpld==50100;
replace dadethnic=24 if fbpld==42300;
replace dadethnic=25 if fbpld==20000;
replace dadethnic=26 if fbpld==42500;
replace dadethnic=27 if fbpld==40400;
replace dadethnic=28 if (fbpld>=50200 & fbpld<=52000) | (fbpld>=52200 & fbpld<=54000) | (fbpld<=54300 & fbpld>=59900);
replace dadethnic=30 if fbpld>=71000 & fbpld<=71050;
replace dadethnic=31 if fbpld>=45500 & fbpld<=45530;
replace dadethnic=32 if fbpld>=43600 & fbpld<=43640;
replace dadethnic=33 if fbpld>=45600 & fbpld<=45610;
replace dadethnic=34 if fbpld>=46000 & fbpld<=46590;
replace dadethnic=35 if fbpld==41100;
replace dadethnic=36 if fbpld>=30000 & fbpld<=30091;
replace dadethnic=37 if fbpld==43800;
replace dadethnic=38 if fbpld==40500;
replace dadethnic=39 if fbpld==42600;
replace dadethnic=40 if (fbpld>=53400 & fbpld<=53440) | fbpld==54100 | (fbpld>=54200 & fbpld<=54220);
replace dadethnic=41 if fbpld==41200;
replace dadethnic=42 if fbpld>=26000 & fbpld<=26095;
replace dadethnic=29 if fbpld>=15000 & fbpld<90000 & dadethnic==.;

gen ethnic=dadethnic;
replace ethnic=momethnic if ethnic==.|ethnic==0;

gen ethnic_small=1 if ethnic==3|ethnic==7|ethnic==14|ethnic==35|ethnic==41|ethnic==21;
replace ethnic_small=2 if ethnic==5|ethnic==8|ethnic==16;
replace ethnic_small=3 if ethnic==22|ethnic==32|ethnic==37;
replace ethnic_small=4 if ethnic==9|ethnic==12|ethnic==36|ethnic==42|ethnic==25;
replace ethnic_small=5 if ethnic==13|ethnic==15|ethnic==27|ethnic==38;
replace ethnic_small=6 if ethnic==4|ethnic==17|ethnic==39|ethnic==24|ethnic==26;
replace ethnic_small=7 if ethnic==31|ethnic==33|ethnic==34;
replace ethnic_small=8 if ethnic==19|ethnic==6|ethnic==18|ethnic==11;
replace ethnic_small=9 if ethnic==10|ethnic==20|ethnic==23|ethnic==28|ethnic==40|ethnic==1|ethnic==2|ethnic==29|ethnic==30;
replace ethnic_small=0 if ethnic==0;

gen ethnic_female=0 if bpl_female<15000;
replace ethnic_female=1 if bpl_female>=60000 & bpl_female<=60099;
replace ethnic_female=2 if bpl_female>=16000 & bpl_female<=16060;
replace ethnic_female=3 if bpl_female>=70000 & bpl_female<=70010;
replace ethnic_female=4 if bpl_female>=45000 & bpl_female<=45080;
replace ethnic_female=5 if bpl_female==42000;
replace ethnic_female=6 if (bpl_female>=45200 & bpl_female<=45212);
replace ethnic_female=7 if bpl_female>=15000 & bpl_female<=15070;
replace ethnic_female=8 if bpl_female>=15080 & bpl_female<=15083;
replace ethnic_female=8 if ethnic_female==7 & mtongue_female==11;
replace ethnic_female=9 if bpl_female>=21000 & bpl_female<=21090;
replace ethnic_female=10 if bpl_female>=50000 & bpl_female<=50040;
replace ethnic_female=11 if bpl_female==41900 | bpl_female==42200 | bpl_female==42400 | bpl_female==43000 | bpl_female==43100 | bpl_female==43200| bpl_female==43500 | bpl_female==43700 | bpl_female==44000|bpl_female==45100| (bpl_female>=45700 & bpl_female<=45900)|bpl_female==41900|bpl_female==42900|bpl_female==44000|bpl_female==49900;
replace ethnic_female=12 if bpl_female==25000;
replace ethnic_female=13 if bpl_female==40000|bpl_female==40200;
replace ethnic_female=14 if (bpl_female>=41000 & bpl_female<=41020) | bpl_female==41300;
replace ethnic_female=15 if bpl_female==40100;
replace ethnic_female=16 if bpl_female==42100;
replace ethnic_female=17 if (bpl_female>=45300 & bpl_female<=45362) | (bpl_female>42100 & bpl_female<=42112);
replace ethnic_female=18 if bpl_female>=43300 & bpl_female<=43330;
replace ethnic_female=19 if bpl_female==45400;
replace ethnic_female=20 if bpl_female>=52100 & bpl_female<=52150;
replace ethnic_female=21 if bpl_female>=41400 & bpl_female<=41410;
replace ethnic_female=22 if bpl_female==43400;
replace ethnic_female=23 if bpl_female==50100;
replace ethnic_female=24 if bpl_female==42300;
replace ethnic_female=25 if bpl_female==20000;
replace ethnic_female=26 if bpl_female==42500;
replace ethnic_female=27 if bpl_female==40400;
replace ethnic_female=28 if (bpl_female>=50200 & bpl_female<=52000) | (bpl_female>=52200 & bpl_female<=54000) | (bpl_female<=54300 & bpl_female>=59900);
replace ethnic_female=30 if bpl_female>=71000 & bpl_female<=71050;
replace ethnic_female=31 if bpl_female>=45500 & bpl_female<=45530;
replace ethnic_female=32 if bpl_female>=43600 & bpl_female<=43640;
replace ethnic_female=33 if bpl_female>=45600 & bpl_female<=45610;
replace ethnic_female=34 if bpl_female>=46000 & bpl_female<=46590;
replace ethnic_female=35 if bpl_female==41100;
replace ethnic_female=36 if bpl_female>=30000 & bpl_female<=30091;
replace ethnic_female=37 if bpl_female==43800;
replace ethnic_female=38 if bpl_female==40500;
replace ethnic_female=39 if bpl_female==42600;
replace ethnic_female=40 if (bpl_female>=53400 & bpl_female<=53440) | bpl_female==54100 | (bpl_female>=54200 & bpl_female<=54220);
replace ethnic_female=41 if bpl_female==41200;
replace ethnic_female=42 if bpl_female>=26000 & bpl_female<=26095;
replace ethnic_female=29 if bpl_female>=15000 & bpl_female<90000 & ethnic_female==.;

gen momethnic_female=0 if mbpl_female<15000;
replace momethnic_female=1 if mbpl_female>=60000 & mbpl_female<=60099;
replace momethnic_female=2 if mbpl_female>=16000 & mbpl_female<=16060;
replace momethnic_female=3 if mbpl_female>=70000 & mbpl_female<=70010;
replace momethnic_female=4 if mbpl_female>=45000 & mbpl_female<=45080;
replace momethnic_female=5 if mbpl_female==42000;
replace momethnic_female=6 if (mbpl_female>=45200 & mbpl_female<=45212);
replace momethnic_female=7 if mbpl_female>=15000 & mbpl_female<=15070;
replace momethnic_female=8 if mbpl_female>=15080 & mbpl_female<=15083;
replace momethnic_female=8 if momethnic_female==7 & mtongue_female==11;
replace momethnic_female=9 if mbpl_female>=21000 & mbpl_female<=21090;
replace momethnic_female=10 if mbpl_female>=50000 & mbpl_female<=50040;
replace momethnic_female=11 if mbpl_female==41900 | mbpl_female==42200 | mbpl_female==42400 | mbpl_female==43000 | mbpl_female==43100 | mbpl_female==43200| mbpl_female==43500 | mbpl_female==43700 | mbpl_female==44000 | mbpl_female==45100|(mbpl_female>=45700 & mbpl_female<=45900)|mbpl_female==41900|mbpl_female==42900|mbpl_female==44000|mbpl_female==49900;
replace momethnic_female=12 if mbpl_female==25000;
replace momethnic_female=13 if mbpl_female==40000|mbpl_female==40200;
replace momethnic_female=14 if (mbpl_female>=41000 & mbpl_female<=41020) | mbpl_female==41300;
replace momethnic_female=15 if mbpl_female==40100;
replace momethnic_female=16 if mbpl_female==42100;
replace momethnic_female=17 if (mbpl_female>=45300 & mbpl_female<=45362) |(mbpl_female>42100 & mbpl_female<=42112);
replace momethnic_female=18 if mbpl_female>=43300 & mbpl_female<=43330;
replace momethnic_female=19 if mbpl_female==45400;
replace momethnic_female=20 if mbpl_female>=52100 & mbpl_female<=52150;
replace momethnic_female=21 if mbpl_female>=41400 & mbpl_female<=41410;
replace momethnic_female=22 if mbpl_female==43400;
replace momethnic_female=23 if mbpl_female==50100;
replace momethnic_female=24 if mbpl_female==42300;
replace momethnic_female=25 if mbpl_female==20000;
replace momethnic_female=26 if mbpl_female==42500;
replace momethnic_female=27 if mbpl_female==40400;
replace momethnic_female=28 if (mbpl_female>=50200 & mbpl_female<=52000) | (mbpl_female>=52200 & mbpl_female<=54000) | (mbpl_female<=54300 & mbpl_female>=59900);
replace momethnic_female=30 if mbpl_female>=71000 & mbpl_female<=71050;
replace momethnic_female=31 if mbpl_female>=45500 & mbpl_female<=45530;
replace momethnic_female=32 if mbpl_female>=43600 & mbpl_female<=43640;
replace momethnic_female=33 if mbpl_female>=45600 & mbpl_female<=45610;
replace momethnic_female=34 if mbpl_female>=46000 & mbpl_female<=46590;
replace momethnic_female=35 if mbpl_female==41100;
replace momethnic_female=36 if mbpl_female>=30000 & mbpl_female<=30091;
replace momethnic_female=37 if mbpl_female==43800;
replace momethnic_female=38 if mbpl_female==40500;
replace momethnic_female=39 if mbpl_female==42600;
replace momethnic_female=40 if (mbpl_female>=53400 & mbpl_female<=53440) | mbpl_female==54100 | (mbpl_female>=54200 & mbpl_female<=54220);
replace momethnic_female=41 if mbpl_female==41200;
replace momethnic_female=42 if mbpl_female>=26000 & mbpl_female<=26095;
replace momethnic_female=29 if mbpl_female>=15000 & mbpl_female<90000 & momethnic_female==.;

gen dadethnic_female=0 if fbpl_female<15000;
replace dadethnic_female=1 if fbpl_female>=60000 & fbpl_female<=60099;
replace dadethnic_female=2 if fbpl_female>=16000 & fbpl_female<=16060;
replace dadethnic_female=3 if fbpl_female>=70000 & fbpl_female<=70010;
replace dadethnic_female=4 if fbpl_female>=45000 & fbpl_female<=45080;
replace dadethnic_female=5 if fbpl_female==42000;
replace dadethnic_female=6 if (fbpl_female>=45200 & fbpl_female<=45212);
replace dadethnic_female=7 if fbpl_female>=15000 & fbpl_female<=15070;
replace dadethnic_female=8 if fbpl_female>=15080 & fbpl_female<=15083;
replace dadethnic_female=8 if dadethnic_female==7 & mtongue_female==11;
replace dadethnic_female=9 if fbpl_female>=21000 & fbpl_female<=21090;
replace dadethnic_female=10 if fbpl_female>=50000 & fbpl_female<=50040;
replace dadethnic_female=11 if fbpl_female==41900 | fbpl_female==42200 | fbpl_female==42400 | fbpl_female==43000 | fbpl_female==43100 | fbpl_female==43200| fbpl_female==43500 | fbpl_female==43700 | fbpl_female==44000|fbpl_female==45100|(fbpl_female>=45700 & fbpl_female<=45900)|fbpl_female==41900|fbpl_female==42900|fbpl_female==44000|fbpl_female==49900;
replace dadethnic_female=12 if fbpl_female==25000;
replace dadethnic_female=13 if fbpl_female==40000|fbpl_female==40200;
replace dadethnic_female=14 if (fbpl_female>=41000 & fbpl_female<=41020) | fbpl_female==41300;
replace dadethnic_female=15 if fbpl_female==40100;
replace dadethnic_female=16 if fbpl_female==42100;
replace dadethnic_female=17 if (fbpl_female>=45300 & fbpl_female<=45362) | (fbpl_female>42100 & fbpl_female<=42112);
replace dadethnic_female=18 if fbpl_female>=43300 & fbpl_female<=43330;
replace dadethnic_female=19 if fbpl_female==45400;
replace dadethnic_female=20 if fbpl_female>=52100 & fbpl_female<=52150;
replace dadethnic_female=21 if fbpl_female>=41400 & fbpl_female<=41410;
replace dadethnic_female=22 if fbpl_female==43400;
replace dadethnic_female=23 if fbpl_female==50100;
replace dadethnic_female=24 if fbpl_female==42300;
replace dadethnic_female=25 if fbpl_female==20000;
replace dadethnic_female=26 if fbpl_female==42500;
replace dadethnic_female=27 if fbpl_female==40400;
replace dadethnic_female=28 if (fbpl_female>=50200 & fbpl_female<=52000) | (fbpl_female>=52200 & fbpl_female<=54000) | (fbpl_female<=54300 & fbpl_female>=59900);
replace dadethnic_female=30 if fbpl_female>=71000 & fbpl_female<=71050;
replace dadethnic_female=31 if fbpl_female>=45500 & fbpl_female<=45530;
replace dadethnic_female=32 if fbpl_female>=43600 & fbpl_female<=43640;
replace dadethnic_female=33 if fbpl_female>=45600 & fbpl_female<=45610;
replace dadethnic_female=34 if fbpl_female>=46000 & fbpl_female<=46590;
replace dadethnic_female=35 if fbpl_female==41100;
replace dadethnic_female=36 if fbpl_female>=30000 & fbpl_female<=30091;
replace dadethnic_female=37 if fbpl_female==43800;
replace dadethnic_female=38 if fbpl_female==40500;
replace dadethnic_female=39 if fbpl_female==42600;
replace dadethnic_female=40 if (fbpl_female>=53400 & fbpl_female<=53440) | fbpl_female==54100 | (fbpl_female>=54200 & fbpl_female<=54220);
replace dadethnic_female=41 if fbpl_female==41200;
replace dadethnic_female=42 if fbpl_female>=26000 & fbpl_female<=26095;
replace dadethnic_female=29 if fbpl_female>=15000 & fbpl_female<90000 & dadethnic_female==.;

replace ethnic_female=dadethnic_female if ethnic_female==.|ethnic_female==0;
replace ethnic_female=momethnic_female if ethnic_female==.|ethnic_female==0;

gen ethnic_small_female=1 if ethnic_female==3|ethnic_female==7|ethnic_female==14|ethnic_female==35|ethnic_female==41|ethnic_female==21;
replace ethnic_small_female=2 if ethnic_female==5|ethnic_female==8|ethnic_female==16;
replace ethnic_small_female=3 if ethnic_female==22|ethnic_female==32|ethnic_female==37;
replace ethnic_small_female=4 if ethnic_female==9|ethnic_female==12|ethnic_female==36|ethnic_female==42|ethnic_female==25;
replace ethnic_small_female=5 if ethnic_female==13|ethnic_female==15|ethnic_female==27|ethnic_female==38;
replace ethnic_small_female=6 if ethnic_female==4|ethnic_female==17|ethnic_female==39|ethnic_female==24|ethnic_female==26;
replace ethnic_small_female=7 if ethnic_female==31|ethnic_female==33|ethnic_female==34;
replace ethnic_small_female=8 if ethnic_female==19|ethnic_female==6|ethnic_female==18|ethnic_female==11;
replace ethnic_small_female=9 if ethnic_female==10|ethnic_female==20|ethnic_female==23|ethnic_female==28|ethnic_female==40|ethnic_female==1|ethnic_female==2|ethnic_female==29|ethnic_female==30;
replace ethnic_small_female=0 if ethnic_female==0;

gen immig_female=bpl_female>=15000 if bpl_female<=90000;
replace immig_female=0 if marst~=1;

*Generate variables classifying the match as being endogamous or exogamous;
gen sameethnic=ethnic_small==ethnic_small_female if ethnic_female~=.;
replace sameethnic=0 if marst~=1 & sameethnic==.;
replace sameethnic=. if year==1940|year==1950;
gen immig_same_female=immig_female*sameethnic;
gen otherethnic=(ethnic_small~=ethnic_small_female & ethnic_small_female~=0) if ethnic_female~=.;
replace otherethnic=0 if marst~=1 & otherethnic==.;
replace otherethnic=. if year==1940|year==1950;
gen native=ethnic_female==0 if ethnic_female~=.;
replace native=0 if marst~=1 & native==.;
replace native=. if year==1940|year==1950;

gen state=statefip;
replace state=floor(bpld/100) if bpld<15000;
replace state=state-1 if state>=4;
replace state=state-1 if state>=7;
replace state=state-1 if state>=13;
replace state=state-1 if state>=41;
replace state=state-1 if state>=49;
drop if state>51;

gen state_female=statefip_female;
replace state_female=floor(bpl_female/100) if bpl_female<15000;
replace state_female=state_female-1 if state_female>=4;
replace state_female=state_female-1 if state_female>=7;
replace state_female=state_female-1 if state_female>=13;
replace state_female=state_female-1 if state_female>=41;
replace state_female=state_female-1 if state_female>=49;

replace statefip=statefip-1 if statefip>=4;
replace statefip=statefip-1 if statefip>=7;
replace statefip=statefip-1 if statefip>=13;
replace statefip=statefip-1 if statefip>=41;
replace statefip=statefip-1 if statefip>=49;

gen samestate=state_female==state if marst==1;

sort ethnic_small period_imm state;
merge ethnic_small period_imm state using instrument;
tab _merge;
drop _merge;

*Generate human capital variables;
replace lit=. if lit==0;
replace lit=0 if lit<=3;
replace lit=1 if lit==4;

replace lit_female=. if lit_female==0;
replace lit_female=0 if lit_female<=3;
replace lit_female=1 if lit_female==4;
replace lit_female=0 if marst~=1 & year<=1930;


replace higrade_female=. if higrade_female==0;
replace higrade=. if higrade==0;
replace higrade=higrade-3;
replace higrade=0 if higrade<0;
replace higrade_female=higrade_female-3;
replace higrade_female=0 if higrade_female<0;
gen higrade_female_all=higrade_female;
replace higrade_female_all=0 if higrade_female==. & year>=1940 & year~=1950;

*Generate marital outcomes;

replace agemarr=. if agemarr<10;
gen nevermarr=marst==6;
gen stillmarried=marst==1|marst==2;
gen marriedtwice=(marrno>=2 & marrno<=6) if marrno<=6;
gen livingwith=marst==1;
gen divorced=marst==3|marst==4;
gen widowed=marst==5;

*Generate labor supply variables;
gen employed=empstat==1 if year~=1920;
gen inlf=labforce==2;
replace wkswork2=. if labforce==2 & wkswork2==0;
replace hrswork2=. if empstat==1 & hrswork2==0;

gen weeks=0 if wkswork2==0;
replace weeks=6.5 if wkswork2==1;
replace weeks=20 if wkswork2==2;
replace weeks=33 if wkswork2==3;
replace weeks=44 if wkswork2==4;
replace weeks=48.5 if wkswork2==5;
replace weeks=51 if wkswork2==6;

gen hours=0 if hrswork2==0;
replace hours=7 if hrswork2==1;
replace hours=22 if hrswork2==2;
replace hours=32 if hrswork2==3;
replace hours=37 if hrswork2==4;
replace hours=40 if hrswork2==5;
replace hours=44 if hrswork2==6;
replace hours=55 if hrswork2==7;
replace hours=65 if hrswork2==8;

replace edscor50=0 if edscor50==9999;

compress;

*Merge with the ethnicity characteristics;

sort ethnic;
merge ethnic using characteristics_ethnic;
tab _merge;
drop _merge;

gen logsex2=log(sexratio_imm_young);
replace logsex2=. if female_imm==0|male_imm==0;
gen logpredsex2=log(pred_sexratio_imm);
gen logpredstock2=log(pred_imm);
gen logstock2=log(stock_imm_young);

*Demean characteristics to make interpretation of interactions easier;

egen mean_diff_grade=mean(diff_grade_female);
egen mean_diff_endog=mean(diff_endogamy_male);

replace diff_grade_female=diff_grade_female-mean_diff_grade;
replace diff_endogamy_male=diff_endogamy_male-mean_diff_endog;
drop mean_diff_grade mean_diff_endog ;

gen inter_educ_iv=pred_sexratio_imm*diff_grade_female;
gen inter_endog_iv=pred_sexratio_imm*diff_endogamy_male;
gen inter_div_iv=pred_sexratio_imm*divorce_rate_male;

gen inter_educ_tot=sexratio_tot*diff_grade_female;
gen inter_endog_tot=sexratio_tot*diff_endogamy_male;
gen inter_div_tot=sexratio_tot*divorce_rate_male;

save final_males, replace;
